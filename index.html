<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rengastarkastus 3.0</title>

<link rel="stylesheet" href="./styles.css">
</head>

<body>
<script>
// Diagnostic overlay to capture runtime errors and promise rejections
;(function(){
  function show(msg){
    try{
      var o=document.getElementById('errorOverlay');
      if(!o){
        o=document.createElement('div');o.id='errorOverlay';
        Object.assign(o.style,{position:'fixed',left:'8px',right:'8px',top:'8px',padding:'12px',background:'#fee',color:'#600',border:'1px solid #c00',zIndex:99999,whiteSpace:'pre-wrap',fontFamily:'monospace',display:'none',maxHeight:'70vh',overflow:'auto'});
        var b=document.createElement('button');b.textContent='Close';b.style.float='right';b.onclick=function(){o.style.display='none'};o.appendChild(b);
        var p=document.createElement('div');p.id='errorOverlayMsg';o.appendChild(p);
        document.body.appendChild(o);
      }
      document.getElementById('errorOverlayMsg').textContent = msg;
      document.getElementById('errorOverlay').style.display = 'block';
    }catch(e){console.error('overlay error',e)}
  }
  window.addEventListener('error', function(ev){
    var m = ev.message + '\n' + (ev.filename||'') + ':' + (ev.lineno||'') + '\n' + (ev.error && ev.error.stack ? ev.error.stack : '');
    console.error('Captured error', m);
    show(m);
  });
  window.addEventListener('unhandledrejection', function(ev){
    var m = 'UnhandledRejection: ' + (ev.reason && ev.reason.stack ? ev.reason.stack : String(ev.reason));
    console.error(m);
    show(m);
  });
  console.log('Diagnostics enabled');
})();
</script>
<div id="app">

<!-- HOME VIEW -->
<section id="view-home" class="view active">
  <h1>Rengastarkastus</h1>

  <div class="card">
    <label>Rekisterinumero</label>
    <div class="autocomplete-wrapper">
      <input id="plate">
      <div class="autocomplete-suggestions" id="plateSuggestions" style="display:none;"></div>
    </div>

    <label>Yritys</label>
    <div class="autocomplete-wrapper">
      <input id="company">
      <div class="autocomplete-suggestions" id="companySuggestions" style="display:none;"></div>
    </div>

    <label>Merkki</label>
    <div class="autocomplete-wrapper">
      <input id="make">
      <div class="autocomplete-suggestions" id="makeSuggestions" style="display:none;"></div>
    </div>

    <label>Malli</label>
    <div class="autocomplete-wrapper">
      <input id="model">
      <div class="autocomplete-suggestions" id="modelSuggestions" style="display:none;"></div>
    </div>

    <label>Ajoneuvotyyppi</label>
    <div id="vehicleType" class="vehicle-type">
      <label><input type="radio" name="vehicleType" value="Kuorma-auto"><span>Kuorma-auto</span></label>
      <label><input type="radio" name="vehicleType" value="Perävaunu"><span>Perävaunu</span></label>
      <label><input type="radio" name="vehicleType" value="Auto"><span>Auto</span></label>
    </div>

    <button class="btn primary" id="btnStartInspection">Uusi tarkastus</button>
    <button class="btn" id="btnOpenConfig">Akseli konfiguraatio</button>
  </div>

  <div class="card">
    <h2>Raportit</h2>
    <div id="historyList"></div>
  </div>
</section>

<!-- CONFIG VIEW -->
<section id="view-config" class="view">
  <header>
    <button class="btn back" data-back>←</button>
    <h2>Konfiguraatio</h2>
  </header>

  <div class="card">
    <label>Akselien määrä</label>
    <div id="axleSelector" class="chip-group"></div>
  </div>

  <div id="configAxles"></div>

  <button class="btn primary" id="btnSaveConfig">Tallenna konfiguraatio</button>
</section>

<!-- MEASURE VIEW -->
<section id="view-measure" class="view">
  <header>
    <button class="btn back" data-back>←</button>
    <h2>Mittaukset</h2>
  </header>

  <div id="measureList"></div>

  <button class="btn primary" id="btnSaveInspection">Tallenna tarkastus</button>
</section>

<!-- PRESET CONFIG MODAL -->
<div id="presetModal" class="preset-modal" style="display:none;">
  <div class="preset-modal-backdrop"></div>
  <div class="preset-modal-card">
    <h2>Valitse ajoneuvotyyppi</h2>
    <div id="presetTypes" class="preset-types"></div>
  </div>
</div>

<!-- AXLE CONFIG MODAL -->
<div id="axleConfigModal" class="preset-modal" style="display:none;">
  <div class="preset-modal-backdrop"></div>
  <div class="preset-modal-card">
    <h2>Valitse akselikonfiguraatio</h2>
    <div id="axleConfigs" class="preset-types"></div>
  </div>
</div>

</div>

<script src="./jspdf.umd.min.js"></script>
<script>
class _StorageKeys {
  static config(plate) { return "config_" + plate; }
  static history() { return "history"; }
  static plates() { return "plates"; }
  static companies() { return "companies"; }
  static makes() { return "makes"; }
  static models() { return "models"; }
  static tyreSizes() { return "tyreSizes"; }
  static tyreMakes() { return "tyreMakes"; }
  static etValues() { return "etValues"; }
  static plateCompanyMap() { return "plateCompanyMap"; }
  static plateTypeMap() { return "plateTypeMap"; }
  static plateMakeModelMap() { return "plateMakeModelMap"; }
}

function loadList(key) {
  const raw = localStorage.getItem(key);
  return raw ? JSON.parse(raw) : [];
}
function saveList(key, list) {
  localStorage.setItem(key, JSON.stringify(list));
}
function loadMap(key) {
  const raw = localStorage.getItem(key);
  return raw ? JSON.parse(raw) : {};
}
function saveMap(key, map) {
  localStorage.setItem(key, JSON.stringify(map));
}

class ConfigManager {
  static load(plate) {
    const raw = localStorage.getItem(_StorageKeys.config(plate));
    return raw ? JSON.parse(raw) : null;
  }
  static save(plate, config) {
    localStorage.setItem(_StorageKeys.config(plate), JSON.stringify(config));
  }
}

class HistoryManager {
  static load() {
    const raw = localStorage.getItem(_StorageKeys.history());
    return raw ? JSON.parse(raw) : [];
  }
  static save(list) {
    localStorage.setItem(_StorageKeys.history(), JSON.stringify(list));
  }
  static add(record) {
    const list = this.load();
    list.push(record);
    this.save(list);
  }
  static lastForPlate(plate) {
    return [...this.load()].reverse().find(r => r.plate === plate) || null;
  }
}

window.StorageKeys = _StorageKeys;
window.loadList = loadList;
window.saveList = saveList;
window.loadMap = loadMap;
window.saveMap = saveMap;
window.ConfigManager = ConfigManager;
window.HistoryManager = HistoryManager;
</script>

<script>
// Vehicle type presets
const VEHICLE_PRESETS = {
  'Kuorma-auto': [
    // 2-axle
    {
      name: '4x2',
      axles: 2,
      data: [
        { type: 'single' },
        { type: 'dual' }
      ]
    },
    {
      name: '4x4',
      axles: 2,
      data: [
        { type: 'single' },
        { type: 'dual' }
      ]
    },

    // 3-axle
    {
      name: '6x2',
      axles: 3,
      data: [
        { type: 'single' },
        { type: 'dual' },
        { type: 'dual' }
      ]
    },
    {
      name: '6x2*4',
      axles: 3,
      data: [
        { type: 'single' },
        { type: 'dual' },
        { type: 'dual' }
      ]
    },
    {
      name: '6x4',
      axles: 3,
      data: [
        { type: 'single' },
        { type: 'dual' },
        { type: 'dual' }
      ]
    },
    {
      name: '6x6',
      axles: 3,
      data: [
        { type: 'single' },
        { type: 'dual' },
        { type: 'dual' }
      ]
    },

    // 4-axle
    {
      name: '8x2',
      axles: 4,
      data: [
        { type: 'single' },
        { type: 'dual' },
        { type: 'dual' },
        { type: 'dual' }
      ]
    },
    {
      name: '8x2*4',
      axles: 4,
      data: [
        { type: 'single' },
        { type: 'dual' },
        { type: 'dual' },
        { type: 'dual' }
      ]
    },
    {
      name: '8x4',
      axles: 4,
      data: [
        { type: 'single' },
        { type: 'dual' },
        { type: 'dual' },
        { type: 'dual' }
      ]
    },
    {
      name: '8x6',
      axles: 4,
      data: [
        { type: 'single' },
        { type: 'dual' },
        { type: 'dual' },
        { type: 'dual' }
      ]
    },
    {
      name: '8x8',
      axles: 4,
      data: [
        { type: 'single' },
        { type: 'dual' },
        { type: 'dual' },
        { type: 'dual' }
      ]
    }
  ],

  'Perävaunu': [
    {
      name: '4x0 (single/single)',
      axles: 2,
      data: [
        { type: 'single' },
        { type: 'single' }
      ]
    },
    {
      name: '4x0 (dual/dual)',
      axles: 2,
      data: [
        { type: 'dual' },
        { type: 'dual' }
      ]
    },
    {
      name: '6x0 (single/single/single)',
      axles: 3,
      data: [
        { type: 'single' },
        { type: 'single' },
        { type: 'single' }
      ]
    },
    {
      name: '6x0 (dual/dual/dual)',
      axles: 3,
      data: [
        { type: 'dual' },
        { type: 'dual' },
        { type: 'dual' }
      ]
    },
    {
      name: '8x0 (dual/dual/dual/dual)',
      axles: 4,
      data: [
        { type: 'dual' },
        { type: 'dual' },
        { type: 'dual' },
        { type: 'dual' }
      ]
    }
  ],

  'Auto': [
    {
      name: '4x2 (single/single)',
      axles: 2,
      data: [
        { type: 'single' },
        { type: 'single' }
      ]
    },
    {
      name: '4x2 (single/dual)',
      axles: 2,
      data: [
        { type: 'single' },
        { type: 'dual' }
      ]
    }
  ]
};



function formatTyreSize(raw) {
  if (!raw) return "";
  if (raw.includes("/")) return raw.trim();
  const d = raw.replace(/\D/g,"");
  // 38555225 -> 385/55R22.5
  if (d.length === 8) return `${d.slice(0,3)}/${d.slice(3,5)}R${d.slice(5,7)}.${d.slice(7)}`;
  // 3855522 -> 385/55R22
  if (d.length === 7) return `${d.slice(0,3)}/${d.slice(3,5)}R${d.slice(5,7)}`;
  return raw.trim();
}
function formatMmValue(val) {
  if (val == null || val === "") return "-";
  const num = Number(val);
  if (Number.isNaN(num)) return String(val);
  return Number.isInteger(num) ? String(num) : num.toFixed(1);
}
function setupAutocomplete(inputEl, suggestionsEl, getItems, onSelect, transformInput=null) {
  function closeSuggestions() {
    suggestionsEl.style.display = "none";
    suggestionsEl.innerHTML = "";
  }

  function openSuggestions(items) {
    if (!items.length) { closeSuggestions(); return; }
    suggestionsEl.innerHTML = "";
    items.forEach(item=>{
      const div = document.createElement("div");
      div.className = "autocomplete-suggestion";
      div.textContent = item;
      div.onclick = (e)=>{ e.stopPropagation(); inputEl.value = item; closeSuggestions(); onSelect(item); };
      suggestionsEl.appendChild(div);
    });
    suggestionsEl.style.display = "block";
  }

  inputEl.addEventListener("input", ()=>{
    let val = inputEl.value;
    if (transformInput) {
      val = transformInput(val);
      inputEl.value = val;
    }
    const all = getItems();
    if (!val) { closeSuggestions(); return; }
    const filtered = all.filter(x => x.toLowerCase().includes(val.toLowerCase()));
    openSuggestions(filtered);
  });

  inputEl.addEventListener("focus", ()=>{
    const val = inputEl.value;
    const all = getItems();
    if (!val) {
      if (all.length) openSuggestions(all.slice(0,10));
    } else {
      const filtered = all.filter(x => x.toLowerCase().includes(val.toLowerCase()));
      openSuggestions(filtered);
    }
  });

  document.addEventListener("click", e=>{
    if (!inputEl.contains(e.target) && !suggestionsEl.contains(e.target)) {
      closeSuggestions();
    }
  });
}

function setupTyreAutocomplete(inputEl, key, formatter=null) {
  const wrap = document.createElement("div");
  wrap.className = "autocomplete-wrapper";
  inputEl.parentNode.insertBefore(wrap, inputEl);
  wrap.appendChild(inputEl);

  const sug = document.createElement("div");
  sug.className = "autocomplete-suggestions";
  sug.style.display = "none";
  wrap.appendChild(sug);

  setupAutocomplete(
    inputEl,
    sug,
    ()=>loadList(key),
    ()=>{},
    formatter
  );
}

function buildAxleUI(containerEl, count, existing=[], StorageKeysRef, formatTyreSizeFn) {
  containerEl.innerHTML = "";

  for (let i=0;i<count;i++) {
    const d = existing[i] || {};

    const card = document.createElement("div");
    card.className = "axle-card";

    card.innerHTML = `
      <h3>Akseli ${i+1}</h3>
      <div class="settings-icon">⚙️</div>
      <div class="settings-menu">
        <div data-copy="size">Kopioi rengaskoko kaikille</div>
        <div data-copy="make">Kopioi merkki kaikille</div>
        <div data-copy="rim">Kopioi vanne kaikille</div>
        <div data-copy="et">Kopioi ET kaikille</div>
      </div>

      <label>Tyyppi</label>
      <select class="axle-type">
        <option value="single"${d.type==="single"?" selected":""}>Yksittäinen</option>
        <option value="dual"${d.type==="dual"?" selected":""}>Paripyörä</option>
      </select>

      <label>Rengaskoko</label>
        <input type="text" class="axle-size" value="${d.size||""}" placeholder="315/70R22.5" inputmode="numeric" pattern="[0-9]*">

      <label>Merkki ja malli</label>
      <input class="axle-make" value="${d.make||""}">

      <label>Vannetyyppi</label>
      <div class="rim-options">
        <label class="rim-option">
          <input type="radio" name="rim-${i}" value="Alumiini" ${!d.rim || d.rim==="Alumiini" ? "checked":""}>
          Alumiini
        </label>
        <label class="rim-option">
          <input type="radio" name="rim-${i}" value="Teräs" ${d.rim==="Teräs" ? "checked":""}>
          Teräs
        </label>
      </div>

      <label>ET-arvo</label>
      <input class="axle-et" value="${d.et||""}">
    `;

    containerEl.appendChild(card);

    setupTyreAutocomplete(card.querySelector(".axle-size"), StorageKeysRef.tyreSizes(), formatTyreSizeFn);
    setupTyreAutocomplete(card.querySelector(".axle-make"), StorageKeysRef.tyreMakes());
    setupTyreAutocomplete(card.querySelector(".axle-et"), StorageKeysRef.etValues());

    card.querySelector(".axle-size").addEventListener("blur", e=>{ e.target.value = formatTyreSizeFn(e.target.value); });

    const icon = card.querySelector(".settings-icon");
    const menu = card.querySelector(".settings-menu");

    icon.onclick = (e)=>{ e.stopPropagation(); document.querySelectorAll(".settings-menu").forEach(m=>m.style.display="none"); menu.style.display = "block"; };
    document.addEventListener("click", ()=>{ menu.style.display = "none"; });

    menu.querySelectorAll("[data-copy]").forEach(btn=>{
      btn.onclick = (e)=>{
        e.stopPropagation();
        const type = btn.dataset.copy;
        const cards = containerEl.querySelectorAll(".axle-card");

        if (type === "size") {
          const val = card.querySelector(".axle-size").value.trim();
          if (!val) return alert("Rengaskoko puuttuu");
          const f = formatTyreSizeFn(val);
          cards.forEach(c=>c.querySelector(".axle-size").value = f);
        }

        if (type === "make") {
          const val = card.querySelector(".axle-make").value.trim();
          cards.forEach(c=>c.querySelector(".axle-make").value = val);
        }

        if (type === "rim") {
          const val = card.querySelector("input[name='rim-"+i+"']:checked").value;
          cards.forEach((c,idx)=>{ c.querySelector("input[name='rim-"+idx+"'][value='"+val+"']").checked = true; });
        }

        if (type === "et") {
          const val = card.querySelector(".axle-et").value.trim();
          cards.forEach(c=>c.querySelector(".axle-et").value = val);
        }
      };
    });
  }
}

function buildPositions(config) {
  const left = [];
  const right = [];

  config.data.forEach((axle, index) => {
    const n = index + 1;

    if (axle.type === "single") {
      left.push(`Akseli ${n} vasen`);
      right.push(`Akseli ${n} oikea`);
    } else {
      left.push(`Akseli ${n} vasen ulompi`);
      left.push(`Akseli ${n} vasen sisempi`);
      right.push(`Akseli ${n} oikea ulompi`);
      right.push(`Akseli ${n} oikea sisempi`);
    }
  });

  return [...left, ...right];
}

function buildMeasurementUI(positions, config, containerEl, previous=null, prevNotes=null, prevPhotos=null, prevSizes=null, prevRims=null, prevMakes=null) {
  containerEl.innerHTML = "";

  const values = positions.map((_,i)=> previous && previous[i]!=null ? Number(previous[i]) : 10);
  const notes = positions.map((_,i)=> prevNotes && prevNotes[i] ? String(prevNotes[i]) : "");
  const photos = positions.map((_,i)=> prevPhotos && prevPhotos[i] ? String(prevPhotos[i]) : null);

  const caption = document.createElement('div');
  caption.className = 'diagram-caption';
  caption.textContent = 'Valitse rengas:';
  containerEl.appendChild(caption);

  const diagram = document.createElement('div');
  diagram.className = 'tyre-diagram';
  containerEl.appendChild(diagram);

  const cfg = (config && config.data) ? config.data : [];
  const totalLeft = cfg.reduce((sum,a)=> sum + (a.type === 'dual' ? 2 : 1), 0);
  let leftIndex = 0;
  let rightIndex = totalLeft;

  const modal = document.createElement('div');
  modal.className = 'tire-modal';
  modal.innerHTML = `
    <div class="tire-modal-backdrop"></div>
    <div class="tire-modal-card">
      <div class="tire-modal-header">
        <div class="tire-modal-title"></div>
        <button class="btn-sm tire-modal-close" type="button">Sulje</button>
      </div>
      <div class="tire-modal-grid"></div>
      <div class="tire-modal-data">
        <label>Rengaskoko</label>
        <input type="text" class="tire-size-input" placeholder="200/55R16" style="width:100%;padding:8px;margin-bottom:8px;border:1px solid #ddd;border-radius:6px;">
        <label>Rengastammi/Malli</label>
        <input type="text" class="tire-make-input" placeholder="Esim. Michelin" style="width:100%;padding:8px;margin-bottom:8px;border:1px solid #ddd;border-radius:6px;">
        <label>Vannetyyppi</label>
        <select class="tire-rim-input" style="width:100%;padding:8px;margin-bottom:8px;border:1px solid #ddd;border-radius:6px;">
          <option value="">Valitse</option>
          <option value="Alumiini">Alumiini</option>
          <option value="Teräs">Teräs</option>
        </select>
      </div>
      <div class="tire-modal-actions">
        <button class="btn-sm note-toggle" type="button">Huomio</button>
        <button class="btn-sm photo-btn" type="button">Kamera</button>
        <input type="file" accept="image/*" capture="environment" class="photo-input" style="display:none">
      </div>
      <div class="note-box" style="display:none;">
        <textarea class="note-input" placeholder="Kirjoita huomio..."></textarea>
      </div>
      <div class="photo-preview" style="display:none;"></div>
    </div>
  `;
  containerEl.appendChild(modal);

  const modalTitle = modal.querySelector('.tire-modal-title');
  const modalGrid = modal.querySelector('.tire-modal-grid');
  const tireSize = modal.querySelector('.tire-size-input');
  const tireMake = modal.querySelector('.tire-make-input');
  const tireRim = modal.querySelector('.tire-rim-input');
  const noteToggle = modal.querySelector('.note-toggle');
  const noteBox = modal.querySelector('.note-box');
  const noteInput = modal.querySelector('.note-input');
  const photoBtn = modal.querySelector('.photo-btn');
  const photoInput = modal.querySelector('.photo-input');
  const photoPreview = modal.querySelector('.photo-preview');
  let currentNode = null;

  function updateTireNode(node) {
    const val = Number(node.dataset.value || 0);
    const note = node.dataset.note || "";
    const photo = node.dataset.photo || "";
    node.querySelector('.tire-value').textContent = formatMmValue(val);
    node.classList.toggle('has-note', !!note);
    node.classList.toggle('has-photo', !!photo);
  }

  function setActiveValue(val) {
    const target = Number(val);
    modalGrid.querySelectorAll('.value-btn').forEach(b=>{
      const btnVal = Number(b.dataset.value);
      const isActive = Math.abs(btnVal - target) < 0.001;
      b.classList.toggle('active', isActive);
    });
  }

  function openModal(node, index) {
    currentNode = node;
    modalTitle.textContent = positions[index] || 'Rengas';

    const tireS = node.dataset.size || "";
    tireSize.value = tireS;
    
    const tireM = node.dataset.make || "";
    tireMake.value = tireM;
    
    const tireR = node.dataset.rim || "";
    tireRim.value = tireR;

    const note = node.dataset.note || "";
    noteInput.value = note;
    noteToggle.classList.toggle('note-has-content', !!note);
    noteBox.style.display = note ? 'block' : 'none';

    const photo = node.dataset.photo || "";
    if (photo) {
      photoPreview.innerHTML = `<img src="${photo}" style="width:100%;height:100%;object-fit:cover">`;
      photoPreview.style.display = 'block';
    } else {
      photoPreview.innerHTML = "";
      photoPreview.style.display = 'none';
    }

    setActiveValue(Number(node.dataset.value || 0));
    modal.classList.add('open');
  }

  function closeModal() {
    modal.classList.remove('open');
    currentNode = null;
  }

  modal.querySelector('.tire-modal-close').onclick = closeModal;
  modal.querySelector('.tire-modal-backdrop').onclick = closeModal;

  for (let i=0;i<=20;i++) {
    const v = i;
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'value-btn';
    btn.dataset.value = String(v);
    btn.textContent = formatMmValue(v);

    let pressTimer = null;
    let longPressTriggered = false;

    function setValue(val) {
      if (!currentNode) return;
      currentNode.dataset.value = String(val);
      updateTireNode(currentNode);
      setActiveValue(val);
    }

    btn.addEventListener('mousedown', ()=>{
      longPressTriggered = false;
      pressTimer = setTimeout(()=>{
        const half = Math.min(v + 0.5, 20);
        setValue(half);
        longPressTriggered = true;
      }, 450);
    });
    btn.addEventListener('mouseup', ()=>{
      if (pressTimer) clearTimeout(pressTimer);
    });
    btn.addEventListener('mouseleave', ()=>{
      if (pressTimer) clearTimeout(pressTimer);
    });
    btn.addEventListener('touchstart', (e)=>{
      e.preventDefault();
      longPressTriggered = false;
      pressTimer = setTimeout(()=>{
        const half = Math.min(v + 0.5, 20);
        setValue(half);
        longPressTriggered = true;
      }, 450);
    }, { passive: false });
    btn.addEventListener('touchend', ()=>{
      if (pressTimer) clearTimeout(pressTimer);
    });

    btn.addEventListener('click', ()=>{
      if (longPressTriggered) return;
      setValue(v);
    });

    modalGrid.appendChild(btn);
  }

  noteToggle.onclick = ()=>{
    noteBox.style.display = noteBox.style.display === 'none' ? 'block' : 'none';
  };

  noteInput.addEventListener('input', ()=>{
    if (!currentNode) return;
    const val = noteInput.value.trim();
    currentNode.dataset.note = val;
    noteToggle.classList.toggle('note-has-content', !!val);
    updateTireNode(currentNode);
  });

  tireSize.addEventListener('input', ()=>{
    if (!currentNode) return;
    const val = tireSize.value.trim();
    currentNode.dataset.size = val;
  });

  tireMake.addEventListener('input', ()=>{
    if (!currentNode) return;
    const val = tireMake.value.trim();
    currentNode.dataset.make = val;
  });

  tireRim.addEventListener('change', ()=>{
    if (!currentNode) return;
    const val = tireRim.value.trim();
    currentNode.dataset.rim = val;
  });

  photoBtn.onclick = ()=> photoInput.click();
  photoInput.onchange = (e)=>{
    const f = e.target.files && e.target.files[0];
    if (!f || !currentNode) return;
    const r = new FileReader();
    r.onload = ()=>{
      currentNode.dataset.photo = r.result;
      photoPreview.innerHTML = `<img src="${r.result}" style="width:100%;height:100%;object-fit:cover">`;
      photoPreview.style.display = 'block';
      updateTireNode(currentNode);
    };
    r.readAsDataURL(f);
  };

  function createTireNode(index, label, axleConfig) {
    const node = document.createElement('button');
    node.type = 'button';
    node.className = 'tire-node';
    node.dataset.index = String(index);
    node.dataset.value = String(values[index] != null ? values[index] : 10);
    if (notes[index]) node.dataset.note = notes[index];
    if (photos[index]) node.dataset.photo = photos[index];
    // Use previous tire data if available, otherwise use axle config
    node.dataset.size = (prevSizes && prevSizes[index]) ? prevSizes[index] : (axleConfig && axleConfig.size ? axleConfig.size : '');
    node.dataset.make = (prevMakes && prevMakes[index]) ? prevMakes[index] : (axleConfig && axleConfig.make ? axleConfig.make : '');
    node.dataset.rim = (prevRims && prevRims[index]) ? prevRims[index] : (axleConfig && axleConfig.rim ? axleConfig.rim : '');
    node.innerHTML = `
      <span class="tire-label">${label || ''}</span>
      <span class="tire-value">${formatMmValue(node.dataset.value)}</span>
      <span class="tire-unit">mm</span>
    `;
    updateTireNode(node);
    node.onclick = ()=> openModal(node, index);
    return node;
  }

  cfg.forEach((axle, axleIdx)=>{
    const row = document.createElement('div');
    row.className = 'axle-row';

    const left = document.createElement('div');
    left.className = 'tire-group left';
    const right = document.createElement('div');
    right.className = 'tire-group right';

    const isDual = axle.type === 'dual';
    if (isDual) {
      left.appendChild(createTireNode(leftIndex++, 'U', axle));
      left.appendChild(createTireNode(leftIndex++, 'S', axle));
      right.appendChild(createTireNode(rightIndex++, 'S', axle));
      right.appendChild(createTireNode(rightIndex++, 'U', axle));
    } else {
      left.appendChild(createTireNode(leftIndex++, '', axle));
      right.appendChild(createTireNode(rightIndex++, '', axle));
    }

    const axleLabel = document.createElement('div');
    axleLabel.className = 'axle-label';
    axleLabel.textContent = `Akseli ${axleIdx+1}`;

    row.appendChild(left);
    row.appendChild(axleLabel);
    row.appendChild(right);
    diagram.appendChild(row);
  });
}

function renderHistory(containerEl, HistoryManagerRef) {
  const list = HistoryManagerRef.load();
  containerEl.innerHTML = "";
  if (!list.length) {
    containerEl.innerHTML = "<p>Ei tallennettuja raportteja.</p>";
    return;
  }

  // Group by company -> plate -> records
  const map = {};
  list.forEach((r, idx)=>{
    const company = r.company || "Ilman yritystä";
    if (!map[company]) map[company] = {};
    if (!map[company][r.plate]) map[company][r.plate] = [];
    map[company][r.plate].push({rec:r, idx});
  });

  Object.keys(map).forEach(company=>{
    const compCard = document.createElement('div');
    compCard.className = 'card';
    compCard.innerHTML = `<h3>${company} <button class="btn-sm" data-download-company="${company}" style="margin-left:8px;">Lataa kaikki</button></h3>`;

    Object.keys(map[company]).forEach(plate=>{
      const arr = map[company][plate];
      const plateDiv = document.createElement('div');
      plateDiv.style.marginBottom = '8px';
      
      const headerDiv = document.createElement('div');
      headerDiv.style.display = 'flex';
      headerDiv.style.alignItems = 'center';
      headerDiv.style.justifyContent = 'space-between';
      headerDiv.style.cursor = 'pointer';
      headerDiv.style.padding = '8px';
      headerDiv.style.backgroundColor = '#f9f9f9';
      headerDiv.style.borderRadius = '6px';
      headerDiv.style.marginBottom = '8px';
      
      const leftPart = document.createElement('div');
      leftPart.style.display = 'flex';
      leftPart.style.alignItems = 'center';
      leftPart.style.gap = '8px';
      leftPart.style.flex = '1';
      
      const toggle = document.createElement('span');
      toggle.textContent = '▼';
      toggle.style.transition = 'transform 0.2s';
      toggle.style.display = 'inline-block';
      toggle.style.fontSize = '0.8rem';
      toggle.dataset.expanded = 'true';
      
      const titleSpan = document.createElement('span');
      titleSpan.innerHTML = `<strong>${plate}</strong> <small>(${arr.length} raporttia)</small>`;
      
      leftPart.appendChild(toggle);
      leftPart.appendChild(titleSpan);
      
      const downloadBtn = document.createElement('button');
      downloadBtn.className = 'btn-sm';
      downloadBtn.setAttribute('data-download-plate', plate);
      downloadBtn.textContent = 'Lataa kaikki (ajoneuvo)';
      downloadBtn.style.marginLeft = '8px';
      downloadBtn.onclick = (e)=>e.stopPropagation();
      
      headerDiv.appendChild(leftPart);
      headerDiv.appendChild(downloadBtn);
      
      const reportsContainer = document.createElement('div');
      reportsContainer.className = 'plate-reports-container';
      reportsContainer.style.display = 'block';
      reportsContainer.style.overflow = 'hidden';
      reportsContainer.style.transition = 'max-height 0.3s ease';
      reportsContainer.style.maxHeight = '1000px';
      
      arr.forEach(entry=>{
        const r = entry.rec;
        const i = entry.idx;
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `
          <div>
            <small>${r.date}</small>
          </div>
          <div class="history-actions">
            <button class="btn-sm primary" data-pdf="${i}">PDF</button>
            <button class="btn-sm danger" data-del="${i}">X</button>
          </div>
        `;
        reportsContainer.appendChild(item);
      });
      
      headerDiv.onclick = ()=>{
        const isExpanded = toggle.dataset.expanded === 'true';
        if (isExpanded) {
          reportsContainer.style.maxHeight = '0px';
          toggle.style.transform = 'rotate(-90deg)';
          toggle.dataset.expanded = 'false';
        } else {
          reportsContainer.style.maxHeight = '1000px';
          toggle.style.transform = 'rotate(0deg)';
          toggle.dataset.expanded = 'true';
        }
      };
      
      plateDiv.appendChild(headerDiv);
      plateDiv.appendChild(reportsContainer);
      compCard.appendChild(plateDiv);
    });

    containerEl.appendChild(compCard);
  });

  containerEl.querySelectorAll('[data-del]').forEach(btn=>{
    btn.onclick = ()=>{
      const list = HistoryManagerRef.load();
      list.splice(btn.dataset.del,1);
      HistoryManagerRef.save(list);
      renderHistory(containerEl, HistoryManagerRef);
    };
  });

  containerEl.querySelectorAll('[data-pdf]').forEach(btn=>{
    btn.onclick = ()=> {
      if (window.generatePdf) window.generatePdf(btn.dataset.pdf);
      else alert('PDF ei saatavilla (jsPDF ei ladattu)');
    };
  });

  containerEl.querySelectorAll('[data-download-company]').forEach(btn=>{
    btn.onclick = ()=>{
      const company = btn.dataset.downloadCompany;
      if (window.generateCompanyPdf) window.generateCompanyPdf(company);
      else alert('PDF-työkalu ei saatavilla');
    };
  });

  containerEl.querySelectorAll('[data-download-plate]').forEach(btn=>{
    btn.onclick = ()=>{
      const plate = btn.dataset.downloadPlate;
      if (window.generateVehiclePdf) window.generateVehiclePdf(plate);
      else alert('PDF-työkalu ei saatavilla');
    };
  });
}

// expose to global for non-module usage
window.formatTyreSize = formatTyreSize;
window.setupAutocomplete = setupAutocomplete;
window.setupTyreAutocomplete = setupTyreAutocomplete;
window.buildAxleUI = buildAxleUI;
window.buildPositions = buildPositions;
window.buildMeasurementUI = buildMeasurementUI;
window.formatMmValue = formatMmValue;
window.renderHistory = renderHistory;
</script>

<script>
function drawTireDiagram(doc, config, values, startX, startY, options={}) {
  if (!config || !config.data || !config.data.length) return startY;

  const rowHeight = options.rowHeight || 12;
  const tireW = options.tireW || 6;
  const tireH = options.tireH || 12;
  const tireR = options.tireR || 3;
  const gap = options.gap || 10;
  const leftX = startX;
  const rightX = startX + (options.rightOffset || 120);
  const labelX = startX + (options.labelOffset || 58);
  const fontSize = options.fontSize || 8;

  const leftCount = config.data.reduce((sum,a)=> sum + (a.type === 'dual' ? 2 : 1), 0);
  let leftIndex = 0;
  let rightIndex = leftCount;

  doc.setFontSize(fontSize);

  function drawTire(x, y, value) {
    doc.setDrawColor(55, 65, 81);
    doc.setFillColor(240, 240, 240);
    doc.roundedRect(x, y, tireW, tireH, tireR, tireR, 'FD');
    doc.setTextColor(17, 24, 39);
    doc.text(formatMmValue(value || 0), x + tireW / 2, y + (tireH / 2) + 2, { align: 'center' });
  }

  config.data.forEach((axle, idx)=>{
    const y = startY + idx * rowHeight;
    doc.text(`A${idx+1}`, labelX, y + 4);

    const isDual = axle.type === 'dual';

    if (isDual) {
      const leftOuter = leftIndex++;
      const leftInner = leftIndex++;
      const rightInner = rightIndex++;
      const rightOuter = rightIndex++;

      drawTire(leftX, y, values[leftOuter]);
      drawTire(leftX + gap, y, values[leftInner]);
      drawTire(rightX, y, values[rightInner]);
      drawTire(rightX + gap, y, values[rightOuter]);
    } else {
      const leftPos = leftIndex++;
      const rightPos = rightIndex++;
      drawTire(leftX, y, values[leftPos]);
      drawTire(rightX + gap, y, values[rightPos]);
    }
  });

  return startY + config.data.length * rowHeight;
}

function buildDiagramHtml(config, values) {
  if (!config || !config.data || !config.data.length) return '';

  const leftCount = config.data.reduce((sum,a)=> sum + (a.type === 'dual' ? 2 : 1), 0);
  let leftIndex = 0;
  let rightIndex = leftCount;

  let html = '<div class="diagram">';
  config.data.forEach((axle, idx)=>{
    const isDual = axle.type === 'dual';
    html += '<div class="diagram-row">';
    html += '<div class="diagram-side">';
    if (isDual) {
      html += `<div class="diagram-tire">${formatMmValue(values[leftIndex++] || 0)}</div>`;
      html += `<div class="diagram-tire">${formatMmValue(values[leftIndex++] || 0)}</div>`;
    } else {
      html += `<div class="diagram-tire">${formatMmValue(values[leftIndex++] || 0)}</div>`;
    }
    html += '</div>';
    html += `<div class="diagram-label">A${idx+1}</div>`;
    html += '<div class="diagram-side right">';
    if (isDual) {
      html += `<div class="diagram-tire">${formatMmValue(values[rightIndex++] || 0)}</div>`;
      html += `<div class="diagram-tire">${formatMmValue(values[rightIndex++] || 0)}</div>`;
    } else {
      html += `<div class="diagram-tire">${formatMmValue(values[rightIndex++] || 0)}</div>`;
    }
    html += '</div>';
    html += '</div>';
  });
  html += '</div>';
  return html;
}

function ensureSpace(doc, y, needed, page) {
  if (y + needed <= page.bottom) return y;
  doc.addPage();
  return page.top;
}

function drawSectionTitle(doc, title, y, page) {
  y = ensureSpace(doc, y, 10, page);
  doc.setFontSize(11);
  doc.setTextColor(31, 41, 55);
  doc.text(title, page.left, y);
  doc.setDrawColor(226, 232, 240);
  doc.line(page.left, y + 2, page.right, y + 2);
  return y + 8;
}

function drawKeyValues(doc, y, items, page) {
  const rowH = 6;
  const colGap = 10;
  const colW = (page.right - page.left - colGap) / 2;
  doc.setFontSize(9);

  for (let i = 0; i < items.length; i += 2) {
    y = ensureSpace(doc, y, rowH, page);
    const left = items[i];
    const right = items[i + 1];

    if (left) {
      doc.setTextColor(107, 114, 128);
      doc.text(left.label + ":", page.left, y);
      doc.setTextColor(17, 24, 39);
      doc.text(left.value || "-", page.left + 28, y);
    }

    if (right) {
      doc.setTextColor(107, 114, 128);
      doc.text(right.label + ":", page.left + colW + colGap, y);
      doc.setTextColor(17, 24, 39);
      doc.text(right.value || "-", page.left + colW + colGap + 28, y);
    }

    y += rowH;
  }

  return y + 2;
}

function drawTable(doc, y, headers, rows, colWidths, page) {
  const rowH = 6;
  const headerH = 7;
  const startX = page.left;

  function drawHeader() {
    doc.setFillColor(248, 250, 252);
    doc.setDrawColor(226, 232, 240);
    doc.rect(startX, y - 5, page.right - page.left, headerH, "F");
    doc.setTextColor(55, 65, 81);
    doc.setFontSize(9);
    let x = startX;
    headers.forEach((h, idx)=>{
      doc.text(h, x + 2, y);
      x += colWidths[idx];
    });
    y += headerH;
  }

  y = ensureSpace(doc, y, headerH + rowH, page);
  drawHeader();

  doc.setTextColor(17, 24, 39);
  doc.setFontSize(9);

  rows.forEach(row=>{
    if (y + rowH > page.bottom) {
      doc.addPage();
      y = page.top + 5;
      drawHeader();
    }
    let x = startX;
    row.forEach((cell, idx)=>{
      doc.text(String(cell || "-"), x + 2, y);
      x += colWidths[idx];
    });
    doc.setDrawColor(226, 232, 240);
    doc.line(startX, y + 2, page.right, y + 2);
    y += rowH;
  });

  return y + 4;
}

function drawPhotoGallery(doc, y, r, page) {
  const photos = (r.photos || []).map((p, idx)=>({ src: p, label: r.positions && r.positions[idx] ? r.positions[idx] : "" }))
    .filter(p=>p.src);
  if (!photos.length) return y;

  doc.addPage();
  y = page.top;
  doc.setFontSize(12);
  doc.setTextColor(31, 41, 55);
  doc.text("Kuvagalleria", page.left, y);
  y += 8;

  const colW = 80;
  const colGap = 10;
  const imgW = colW;
  const imgH = 50;
  const labelH = 5;
  const startX = page.left;

  let x = startX;
  let rowY = y;

  photos.forEach((p, idx)=>{
    if (rowY + imgH + labelH > page.bottom) {
      doc.addPage();
      rowY = page.top;
      x = startX;
    }

    try {
      const m = (p.src.match(/^data:image\/(\w+);base64,/) || [])[1] || "jpeg";
      const fmt = (m.toUpperCase()==='JPG'?'JPEG':m.toUpperCase());
      doc.addImage(p.src, fmt, x, rowY, imgW, imgH);
    } catch(e) {}

    doc.setFontSize(8);
    doc.setTextColor(55, 65, 81);
    doc.text(p.label || "", x, rowY + imgH + 4);

    if (x + colW + colGap + colW <= page.right) {
      x += colW + colGap;
    } else {
      x = startX;
      rowY += imgH + labelH + 8;
    }
  });

  return page.bottom;
}

function renderReport(doc, r, options={}) {
  const page = { left: 20, right: 190, top: 18, bottom: 280 };
  let y = page.top;

  doc.setFillColor(248, 250, 252);
  doc.setDrawColor(226, 232, 240);
  doc.rect(page.left, y, page.right - page.left, 16, "F");
  doc.setTextColor(15, 23, 42);
  doc.setFontSize(15);
  doc.text("Rengastarkastusraportti", page.left + 4, y + 11);
  doc.setFontSize(9);
  doc.setTextColor(75, 85, 99);
  doc.text(r.date || "", page.right - 2, y + 11, { align: 'right' });
  y += 22;

  y = drawSectionTitle(doc, "Ajoneuvon tiedot", y, page);
  y = drawKeyValues(doc, y, [
    { label: "Rek", value: r.plate || "-" },
    { label: "Yritys", value: r.company || "-" },
    { label: "Merkki", value: r.make || "-" },
    { label: "Malli", value: r.model || "-" },
    { label: "Tyyppi", value: r.type || "-" },
    { label: "Akselien lkm", value: r.config && r.config.data ? String(r.config.data.length) : "-" }
  ], page);

  y = drawSectionTitle(doc, "Akselikonfiguraatio", y, page);
  
  // Build axle-level tire data from per-position data
  const axleRows = [];
  if (r.config && r.config.data) {
    const totalLeft = r.config.data.reduce((sum,a)=> sum + (a.type === 'dual' ? 2 : 1), 0);
    let leftIdx = 0, rightIdx = totalLeft;
    
    r.config.data.forEach((axle, axleNum)=>{
      const isDual = axle.type === 'dual';
      let tireSize = "-", tireRim = "-";
      
      if (isDual) {
        const firstLeftIdx = leftIdx;
        tireSize = (r.tireSizes && r.tireSizes[firstLeftIdx]) ? r.tireSizes[firstLeftIdx] : axle.size || "-";
        tireRim = (r.tireRims && r.tireRims[firstLeftIdx]) ? r.tireRims[firstLeftIdx] : axle.rim || "-";
        leftIdx += 2;
        rightIdx += 2;
      } else {
        tireSize = (r.tireSizes && r.tireSizes[leftIdx]) ? r.tireSizes[leftIdx] : axle.size || "-";
        tireRim = (r.tireRims && r.tireRims[leftIdx]) ? r.tireRims[leftIdx] : axle.rim || "-";
        leftIdx += 1;
        rightIdx += 1;
      }
      
      axleRows.push([
        String(axleNum+1),
        tireSize,
        axle.make || "-",
        tireRim,
        axle.et || "-"
      ]);
    });
  }
  y = drawTable(doc, y, ["Akseli","Koko","Merkki","Vanne","ET"], axleRows, [16, 40, 48, 30, 16], page);

  y = drawSectionTitle(doc, "Rengaskartta", y, page);
  y = ensureSpace(doc, y, 30, page);
  y = drawTireDiagram(doc, r.config, r.values || [], page.left, y, { rightOffset:120, labelOffset:58, tireW:6, tireH:12, tireR:3 });
  y += 6;

  y = drawSectionTitle(doc, "Rengasmittaukset", y, page);
  const rows = (r.positions || []).map((p,i)=>{
    const v = r.values && r.values[i];
    const w = r.wear && r.wear[i];
    const size = r.tireSizes && r.tireSizes[i] ? r.tireSizes[i] : "-";
    const maker = r.tireMakes && r.tireMakes[i] ? r.tireMakes[i] : "-";
    let note = r.notes && r.notes[i] ? r.notes[i] : "";
    if (!note) { if (v < 2) note = "Vaihda"; else if (v < 4) note = "Seurattava"; }
    return [p, size, maker, formatMmValue(v), w != null ? String(w) : "-", note || "-"];
  });
  y = drawTable(doc, y, ["Sijainti","Koko","Merkki","Mitta (mm)","Kuluminen","Huomio"], rows, [50, 35, 35, 25, 25, 30], page);

  if (options.photoMode === 'gallery') {
    drawPhotoGallery(doc, y, r, page);
  }
}

function generatePdf(index) {
  if (!window.HistoryManager) return alert('Historia ei saatavilla');
  if (!window.jspdf) return alert('jsPDF ei ladattu - lataa sivu palvelimelta tai lisää jspdf paikallisesti');
  const { jsPDF } = window.jspdf;
  const list = window.HistoryManager.load();
  const r = list[index];
  if (!r) return;

  const doc = new jsPDF();
  renderReport(doc, r, { photoMode: 'gallery' });
  doc.save((r.plate||"raportti")+"_raportti.pdf");
}

window.generatePdf = generatePdf;

function generateCompanyPdf(company) {
  if (!window.HistoryManager) return alert('Historia ei saatavilla');
  const raw = window.HistoryManager.load().filter(r => (r.company||"Ilman yritystä") === company);
  // Keep newest-first but only the newest record per vehicle (plate)
  const reversed = raw.slice().reverse();
  const seen = new Set();
  const list = [];
  for (const r of reversed) {
    if (!seen.has(r.plate)) { seen.add(r.plate); list.push(r); }
  }
  if (!list.length) return alert('Ei raportteja valitulle yritykselle');

  // If real jsPDF is available, produce a single PDF with one vehicle per page
  if (window.jspdf && window.jspdf.jsPDF && typeof window.jspdf.jsPDF === 'function') {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    list.forEach((r, idx) => {
      if (idx > 0) doc.addPage();
      renderReport(doc, r, { photoMode: 'gallery' });
    });

    doc.save((company||'yritys')+"_raportit.pdf");
    return;
  }

  // Fallback: open printable HTML with page-breaks and trigger print (user can Save as PDF)
  let html = '<!doctype html><html><head><meta charset="utf-8"><title>Raportit '+(company||'')+'</title>'+
    '<style>body{font-family:Arial,Helvetica,sans-serif;font-size:12px;padding:12px} .page{page-break-after:always;margin-bottom:12px} table{border-collapse:collapse;width:100%} th,td{border:1px solid #ccc;padding:6px;text-align:left} .diagram{display:flex;flex-direction:column;gap:6px;margin:6px 0 12px} .diagram-row{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px} .diagram-side{display:flex;gap:6px;justify-content:flex-start} .diagram-side.right{justify-content:flex-end} .diagram-tire{width:20px;height:36px;border:1px solid #222;border-radius:999px;display:flex;align-items:center;justify-content:center;font-size:9px;color:#fff;background:linear-gradient(180deg,#3a3a3a,#111)} .diagram-label{font-size:10px;color:#333}</style></head><body>';

  list.forEach(r=>{
    html += `<div class="page"><h2>Rek ${r.plate} — ${r.date}</h2><p>Yritys: ${r.company||'-'}<br/>Tyyppi: ${r.type||'-'}</p>`;
    html += '<h3>Akselikonfiguraatio</h3><table><tr><th>Akseli</th><th>Koko</th><th>Merkki</th><th>Vanne</th><th>ET</th></tr>';
    (r.config && r.config.data || []).forEach((a,i)=>{ html += `<tr><td>${i+1}</td><td>${a.size||'-'}</td><td>${a.make||'-'}</td><td>${a.rim||'-'}</td><td>${a.et||'-'}</td></tr>`; });
    html += '</table>';
    html += '<h3>Rengaskartta</h3>';
    html += buildDiagramHtml(r.config, r.values || []);
    html += '<h3>Mittaukset</h3><table><tr><th>Sijainti</th><th>Koko</th><th>Merkki</th><th>Mitta</th><th>Kuluminen</th><th>Huomio</th><th>Kuva</th></tr>';
    (r.positions || []).forEach((p,i)=>{
      const v = r.values && r.values[i];
      const w = r.wear && r.wear[i];
      const size = r.tireSizes && r.tireSizes[i] ? r.tireSizes[i] : "-";
      const maker = r.tireMakes && r.tireMakes[i] ? r.tireMakes[i] : "-";
      let note = r.notes && r.notes[i] ? r.notes[i] : "";
      if (!note) { if (v<2) note = 'Vaihda'; else if (v<4) note = 'Seurattava'; }
      const photo = r.photos && r.photos[i] ? r.photos[i] : null;
      html += `<tr><td>${p}</td><td>${size}</td><td>${maker}</td><td>${v}</td><td>${w!=null?w:'-'}</td><td>${note||'-'}</td><td>${photo?`<img src="${photo}" style="max-width:160px;max-height:90px">`:'-'}</td></tr>`;
    });
    html += '</table></div>';
  });

  html += '</body></html>';
  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}

window.generateCompanyPdf = generateCompanyPdf;

function generateVehiclePdf(plate) {
  if (!window.HistoryManager) return alert('Historia ei saatavilla');
  const raw = window.HistoryManager.load().filter(r => r.plate === plate);
  if (!raw.length) return alert('Ei raportteja valitulle ajoneuvolle');

  // newest-first
  const list = raw.slice().reverse();

  if (window.jspdf && window.jspdf.jsPDF && typeof window.jspdf.jsPDF === 'function') {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    list.forEach((r, idx) => {
      if (idx > 0) doc.addPage();

      renderReport(doc, r, { photoMode: 'gallery' });
    });

    doc.save((plate||'ajoneuvo')+"_raportit.pdf");
    return;
  }

  // Fallback printable HTML
  let html = '<!doctype html><html><head><meta charset="utf-8"><title>Raportit '+(plate||'')+'</title>'+
    '<style>body{font-family:Arial,Helvetica,sans-serif;font-size:12px;padding:12px} .page{page-break-after:always;margin-bottom:12px} table{border-collapse:collapse;width:100%} th,td{border:1px solid #ccc;padding:6px;text-align:left} .diagram{display:flex;flex-direction:column;gap:6px;margin:6px 0 12px} .diagram-row{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px} .diagram-side{display:flex;gap:6px;justify-content:flex-start} .diagram-side.right{justify-content:flex-end} .diagram-tire{width:20px;height:36px;border:1px solid #222;border-radius:999px;display:flex;align-items:center;justify-content:center;font-size:9px;color:#fff;background:linear-gradient(180deg,#3a3a3a,#111)} .diagram-label{font-size:10px;color:#333}</style></head><body>';

  list.forEach(r=>{
    html += `<div class="page"><h2>Rek ${r.plate} — ${r.date}</h2><p>Yritys: ${r.company||'-'}<br/>Tyyppi: ${r.type||'-'}</p>`;
    html += '<h3>Akselikonfiguraatio</h3><table><tr><th>Akseli</th><th>Koko</th><th>Merkki</th><th>Vanne</th><th>ET</th></tr>';
    (r.config && r.config.data || []).forEach((a,i)=>{ html += `<tr><td>${i+1}</td><td>${a.size||'-'}</td><td>${a.make||'-'}</td><td>${a.rim||'-'}</td><td>${a.et||'-'}</td></tr>`; });
    html += '</table>';
    html += '<h3>Rengaskartta</h3>';
    html += buildDiagramHtml(r.config, r.values || []);
    html += '<h3>Mittaukset</h3><table><tr><th>Sijainti</th><th>Koko</th><th>Merkki</th><th>Mitta</th><th>Kuluminen</th><th>Huomio</th></tr>';
    (r.positions || []).forEach((p,i)=>{
      const v = r.values && r.values[i];
      const w = r.wear && r.wear[i];
      const size = r.tireSizes && r.tireSizes[i] ? r.tireSizes[i] : "-";
      const maker = r.tireMakes && r.tireMakes[i] ? r.tireMakes[i] : "-";
      let note = r.notes && r.notes[i] ? r.notes[i] : "";
      if (!note) { if (v<2) note = 'Vaihda'; else if (v<4) note = 'Seurattava'; }
      html += `<tr><td>${p}</td><td>${size}</td><td>${maker}</td><td>${v}</td><td>${w!=null?w:'-'}</td><td>${note||'-'}</td></tr>`;
    });
    html += '</table></div>';
  });

  html += '</body></html>';
  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}

window.generateVehiclePdf = generateVehiclePdf;
</script>

<script>(function(){
// Using globals attached to window instead of ES module imports to allow file:// usage
const StorageKeys = window.StorageKeys;
const loadList = window.loadList;
const loadMap = window.loadMap;
const saveList = window.saveList;
const saveMap = window.saveMap;
const ConfigManager = window.ConfigManager;
const HistoryManager = window.HistoryManager;

const formatTyreSize = window.formatTyreSize;
const setupAutocomplete = window.setupAutocomplete;
const setupTyreAutocomplete = window.setupTyreAutocomplete;
const buildAxleUI = window.buildAxleUI;
const buildPositions = window.buildPositions;
const buildMeasurementUI = window.buildMeasurementUI;
const renderHistory = window.renderHistory;

// Elements
const plateInput = document.getElementById("plate");
const companyInput = document.getElementById("company");
const typeInput = document.getElementById("vehicleType");
const axleSelector = document.getElementById("axleSelector");
const configAxles = document.getElementById("configAxles");
const measureList = document.getElementById("measureList");
const historyList = document.getElementById("historyList");

const plateSuggestions = document.getElementById("plateSuggestions");
const companySuggestions = document.getElementById("companySuggestions");

let currentConfig = null;
let currentPositions = null;

// Autocomplete setup
setupAutocomplete(
  plateInput,
  plateSuggestions,
  ()=>loadList(StorageKeys.plates()),
  (plate)=>{
    const map = loadMap(StorageKeys.plateCompanyMap());
    if (map[plate]) companyInput.value = map[plate];
  },
  (val)=>val.toUpperCase()
);

setupAutocomplete(
  companyInput,
  companySuggestions,
  ()=>loadList(StorageKeys.companies()),
  ()=>{}
);

const makeInput = document.getElementById('make');
const makeSuggestions = document.getElementById('makeSuggestions');
const modelInput = document.getElementById('model');
const modelSuggestions = document.getElementById('modelSuggestions');

setupAutocomplete(
  makeInput,
  makeSuggestions,
  ()=>loadList(StorageKeys.makes()),
  ()=>{}
);

setupAutocomplete(
  modelInput,
  modelSuggestions,
  ()=>loadList(StorageKeys.models()),
  ()=>{}
);

// Build axle chips
[2,3,4,5].forEach(n=>{
  const chip = document.createElement('div');
  chip.className = 'chip';
  chip.dataset.axles = n;
  chip.textContent = n + ' akselia';
  if (n===2) chip.classList.add('active');
  axleSelector.appendChild(chip);
});

// Open config - show vehicle type preset selector for axle configuration
document.getElementById("btnOpenConfig").onclick = ()=>{
  const plate = plateInput.value.trim().toUpperCase();
  if (!plate) return alert("Syötä rekisterinumero");
  plateInput.value = plate;

  const map = loadMap(StorageKeys.plateCompanyMap());
  if (map[plate]) companyInput.value = map[plate];

  const makemodelmap = loadMap(StorageKeys.plateMakeModelMap());
  if (makemodelmap[plate]) {
    makeInput.value = makemodelmap[plate].make || '';
    modelInput.value = makemodelmap[plate].model || '';
  }

  const vehicleTypeEl = document.querySelector('#vehicleType input[type="radio"]:checked');
  const vehicleType = vehicleTypeEl ? vehicleTypeEl.value : 'Auto';
  openAxleConfigModal(vehicleType);
};

// Show view helper
function showView(id) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// Back buttons
document.querySelectorAll('[data-back]').forEach(btn=> btn.addEventListener('click', ()=> showView('view-home')));

// Axle selector click
axleSelector.onclick = e=>{
  const chip = e.target.closest('.chip'); if (!chip) return;
  axleSelector.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active');
  const count = Number(chip.dataset.axles);
  currentConfig = currentConfig || { axles:count, data:[] };
  currentConfig.axles = count;
  buildAxleUI(configAxles, count, currentConfig.data, StorageKeys, formatTyreSize);
};

// Save config
document.getElementById('btnSaveConfig').onclick = ()=>{
  const plate = plateInput.value.trim().toUpperCase();
  if (!plate) return alert('Syötä rekisterinumero');
  plateInput.value = plate;

  const cards = configAxles.querySelectorAll('.axle-card');
  const data = [...cards].map((c,idx)=>({
    type:c.querySelector('.axle-type').value,
    size:formatTyreSize(c.querySelector('.axle-size').value),
    make:c.querySelector('.axle-make').value,
    rim:c.querySelector("input[name='rim-"+idx+"']:checked").value,
    et:c.querySelector('.axle-et').value
  }));

  currentConfig.data = data;
  ConfigManager.save(plate, currentConfig);

  alert('Konfiguraatio tallennettu');
  showView('view-home');
};

// Preset modal functions
const presetModal = document.getElementById('presetModal');
const presetTypes = document.getElementById('presetTypes');
const axleConfigModal = document.getElementById('axleConfigModal');
const axleConfigs = document.getElementById('axleConfigs');
let selectedPresetType = null;
let selectedVehicleForConfig = null;

function initPresetModal() {
  presetTypes.innerHTML = '';
  Object.keys(VEHICLE_PRESETS).forEach(type => {
    const cfgList = VEHICLE_PRESETS[type];
    const firstCfg = cfgList[0];
    const card = document.createElement('div');
    card.className = 'preset-type-card';
    const icon = type === 'Kuorma-auto' ? '🚛' : (type === 'Perävaunu' ? '📦' : '🚗');
    const axleCount = firstCfg.data.filter(a=>a.type==='single').length + ' yks. + ' + firstCfg.data.filter(a=>a.type==='dual').length + ' pari';
    card.innerHTML = `
      <div class="preset-type-icon">${icon}</div>
      <div class="preset-type-name">${type}</div>
      <div class="preset-type-info">${firstCfg.axles} akselia<br>${axleCount}</div>
    `;
    card.onclick = ()=>{
      selectedPresetType = type;
      presetTypes.querySelectorAll('.preset-type-card').forEach(c=>c.classList.remove('selected'));
      card.classList.add('selected');
      setTimeout(()=>startInspectionWithPreset(type), 200);
    };
    presetTypes.appendChild(card);
  });
}

function initAxleConfigModal(vehicleType) {
  axleConfigs.innerHTML = '';
  const cfgList = VEHICLE_PRESETS[vehicleType];
  if (!cfgList) return;
  cfgList.forEach((cfg, idx) => {
    const card = document.createElement('div');
    card.className = 'preset-type-card';
    card.innerHTML = `
      <div class="preset-type-name" style="font-size:1.1rem;">${cfg.name}</div>
    `;
    card.onclick = ()=>{
      currentConfig = { axles: cfg.axles, data: JSON.parse(JSON.stringify(cfg.data)) };
      closeAxleConfigModal();
      const plate = plateInput.value.trim().toUpperCase();
      ConfigManager.save(plate, currentConfig);
      alert('Konfiguraatio tallennettu');
      showView('view-home');
    };
    axleConfigs.appendChild(card);
  });
}

function openAxleConfigModal(vehicleType) {
  selectedVehicleForConfig = vehicleType;
  initAxleConfigModal(vehicleType);
  axleConfigModal.classList.add('open');
  axleConfigModal.style.display = 'flex';
}

function closeAxleConfigModal() {
  axleConfigModal.classList.remove('open');
  axleConfigModal.style.display = 'none';
  selectedVehicleForConfig = null;
}

function openPresetModal() {
  initPresetModal();
  presetModal.classList.add('open');
  presetModal.style.display = 'flex';
}

function closePresetModal() {
  presetModal.classList.remove('open');
  presetModal.style.display = 'none';
  selectedPresetType = null;
}

function startInspectionWithPreset(vehicleType) {
  const plate = plateInput.value.trim().toUpperCase();
  if (!plate) { closePresetModal(); return alert('Syötä rekisterinumero'); }
  
  closePresetModal();
  plateInput.value = plate;

  const map = loadMap(StorageKeys.plateCompanyMap());
  if (map[plate]) companyInput.value = map[plate];

  // Load first config from presets
  const presetList = VEHICLE_PRESETS[vehicleType];
  if (!presetList || presetList.length === 0) return alert('Konfiguraatiota ei löydy');
  const presetCfg = presetList[0];
  
  currentConfig = { axles: presetCfg.axles, data: JSON.parse(JSON.stringify(presetCfg.data)) };
  currentPositions = buildPositions(currentConfig);

  const last = HistoryManager.lastForPlate(plate);
  const prevValues = last?last.values:null;
  const prevNotes = last?last.notes:null;
  const prevPhotos = last?last.photos:null;
  const prevSizes = last?last.tireSizes:null;
  const prevMakes = last?last.tireMakes:null;
  const prevRims = last?last.tireRims:null;

  // Set vehicle type
  const typeInputs = document.querySelectorAll('#vehicleType input[type="radio"]');
  const plateTypeMap = loadMap(StorageKeys.plateTypeMap());
  const lastWithType = [...HistoryManager.load()].reverse().find(r => r.plate === plate && r.type) || null;
  
  if (plateTypeMap[plate]) {
    typeInputs.forEach(b=>{ b.checked = (b.value === plateTypeMap[plate]); });
  } else if (lastWithType && lastWithType.type) {
    typeInputs.forEach(b=>{ b.checked = (b.value === lastWithType.type); });
  } else {
    typeInputs.forEach(b=>{ b.checked = (b.value === vehicleType); });
  }
  
  const checkedNow = document.querySelector('#vehicleType input[type="radio"]:checked');
  if (checkedNow) window.__selectedVehicleType = checkedNow.value;

  buildMeasurementUI(currentPositions, currentConfig, measureList, prevValues, prevNotes, prevPhotos, prevSizes, prevRims, prevMakes);
  showView('view-measure');
}

// Start inspection
document.getElementById('btnStartInspection').onclick = ()=>{
  const plate = plateInput.value.trim().toUpperCase();
  if (!plate) return alert('Syötä rekisterinumero');
  plateInput.value = plate;

  const map = loadMap(StorageKeys.plateCompanyMap());
  if (map[plate]) companyInput.value = map[plate];

  const makemodelmap = loadMap(StorageKeys.plateMakeModelMap());
  if (makemodelmap[plate]) {
    makeInput.value = makemodelmap[plate].make || '';
    modelInput.value = makemodelmap[plate].model || '';
  }

  const cfg = ConfigManager.load(plate);
  if (!cfg) return alert('Tee akseli konfiguraatio ensin');

  currentConfig = cfg;
  currentPositions = buildPositions(cfg);

  const last = HistoryManager.lastForPlate(plate);
  const prevValues = last?last.values:null;
  const prevNotes = last?last.notes:null;
  const prevPhotos = last?last.photos:null;
  const prevSizes = last?last.tireSizes:null;
  const prevMakes = last?last.tireMakes:null;
  const prevRims = last?last.tireRims:null;

  const typeInputs = document.querySelectorAll('#vehicleType input[type="radio"]');
  const plateTypeMap = loadMap(StorageKeys.plateTypeMap());
  const lastWithType = [...HistoryManager.load()].reverse().find(r => r.plate === plate && r.type) || null;
  
  if (plateTypeMap[plate]) {
    typeInputs.forEach(b=>{ b.checked = (b.value === plateTypeMap[plate]); });
  } else if (lastWithType && lastWithType.type) {
    typeInputs.forEach(b=>{ b.checked = (b.value === lastWithType.type); });
  } else {
    typeInputs.forEach(b=>{ b.checked = false; });
  }
  
  const checkedNow = document.querySelector('#vehicleType input[type="radio"]:checked');
  if (checkedNow) window.__selectedVehicleType = checkedNow.value;

  buildMeasurementUI(currentPositions, currentConfig, measureList, prevValues, prevNotes, prevPhotos, prevSizes, prevRims, prevMakes);
  showView('view-measure');
};

// Close modal on backdrop click
presetModal.querySelector('.preset-modal-backdrop').onclick = closePresetModal;
axleConfigModal.querySelector('.preset-modal-backdrop').onclick = closeAxleConfigModal;

// Save inspection
document.getElementById('btnSaveInspection').onclick = ()=>{
  const plate = plateInput.value.trim().toUpperCase();
  const company = companyInput.value.trim();
  const make = makeInput.value.trim();
  const model = modelInput.value.trim();
  const selTypeEl = document.querySelector('#vehicleType input[type="radio"]:checked');
  let type = selTypeEl ? selTypeEl.value : (window.__selectedVehicleType || '');
  console.log('SaveInspection debug BEFORE save:', { plate, type, inputs: document.querySelectorAll('#vehicleType input[type="radio"]').length, storedBefore: loadMap(StorageKeys.plateTypeMap())[plate] });

  if (!plate) return alert('Rekisterinumero puuttuu');
  if (!currentConfig) return alert('Konfiguraatio puuttuu');

  plateInput.value = plate;

  const nodes = [...measureList.querySelectorAll('.tire-node')]
    .sort((a,b)=>Number(a.dataset.index)-Number(b.dataset.index));
  const values = nodes.map(n=>parseFloat(n.dataset.value || 0));
  const notes = nodes.map(n=> (n.dataset.note || '').trim() || null);
  const photos = nodes.map(n=> n.dataset.photo || null);
  const tireSizes = nodes.map(n=> (n.dataset.size || '').trim() || null);
  const tireMakes = nodes.map(n=> (n.dataset.make || '').trim() || null);
  const tireRims = nodes.map(n=> (n.dataset.rim || '').trim() || null);

  const last = HistoryManager.lastForPlate(plate);
  const wear = values.map((v,i)=>{
    if (!last || !last.values || last.values[i]==null) return null;
    return (last.values[i]-v).toFixed(1);
  });

  const record = {
    plate,
    company,
    make,
    model,
    type,
    date:new Date().toLocaleString(),
    values,
    wear,
    config:currentConfig,
    positions:currentPositions,
    notes,
    photos,
    tireSizes,
    tireMakes,
    tireRims
  };

  HistoryManager.add(record);

  const plates = loadList(StorageKeys.plates());
  if (!plates.includes(plate)) { plates.push(plate); saveList(StorageKeys.plates(), plates); }

  if (company) {
    const companies = loadList(StorageKeys.companies());
    if (!companies.includes(company)) { companies.push(company); saveList(StorageKeys.companies(), companies); }
  }

  if (make) {
    const makes = loadList(StorageKeys.makes());
    if (!makes.includes(make)) { makes.push(make); saveList(StorageKeys.makes(), makes); }
  }

  if (model) {
    const models = loadList(StorageKeys.models());
    if (!models.includes(model)) { models.push(model); saveList(StorageKeys.models(), models); }
  }

  const map = loadMap(StorageKeys.plateCompanyMap());
  if (company) { map[plate] = company; saveMap(StorageKeys.plateCompanyMap(), map); }

  const makemodelmap = loadMap(StorageKeys.plateMakeModelMap());
  if (make || model) { makemodelmap[plate] = { make, model }; saveMap(StorageKeys.plateMakeModelMap(), makemodelmap); }

  // Remember vehicle type per plate
  const plateTypeMap = loadMap(StorageKeys.plateTypeMap());
  if (type) { plateTypeMap[plate] = type; saveMap(StorageKeys.plateTypeMap(), plateTypeMap); console.log('SaveInspection debug AFTER save:', { saved: plateTypeMap[plate] }); }

  currentConfig.data.forEach(a=>{
    if (a.size) {
      const list = loadList(StorageKeys.tyreSizes()); if (!list.includes(a.size)) { list.push(a.size); saveList(StorageKeys.tyreSizes(), list); }
    }
    if (a.make) {
      const list = loadList(StorageKeys.tyreMakes()); if (!list.includes(a.make)) { list.push(a.make); saveList(StorageKeys.tyreMakes(), list); }
    }
    if (a.et) {
      const list = loadList(StorageKeys.etValues()); if (!list.includes(a.et)) { list.push(a.et); saveList(StorageKeys.etValues(), list); }
    }
  });

  alert('Tarkastus tallennettu');
  showView('view-home');
  renderHistory(historyList, HistoryManager);
};

// Initial render
renderHistory(historyList, HistoryManager);

// Vehicle type radio change handler: keep a global selected value
(function(){
  const radios = document.querySelectorAll('#vehicleType input[type="radio"]');
  radios.forEach(r => r.addEventListener('change', (e)=>{
    window.__selectedVehicleType = e.target.value;
    try{ const m = loadMap(StorageKeys.plateTypeMap()); /* no-op, just ensure function is available */ }catch(e){}
    console.log('vehicleType change ->', window.__selectedVehicleType);
  }));
})();

// Expose helper for other scripts
window.__app = { renderHistory };
})();</script>
</body>
</html>
