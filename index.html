<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rengastarkastus 3.0</title>

<link rel="stylesheet" href="./styles.css">
</head>

<body>
<script>
// Diagnostic overlay to capture runtime errors and promise rejections
;(function(){
  function show(msg){
    try{
      var o=document.getElementById('errorOverlay');
      if(!o){
        o=document.createElement('div');o.id='errorOverlay';
        Object.assign(o.style,{position:'fixed',left:'8px',right:'8px',top:'8px',padding:'12px',background:'#fee',color:'#600',border:'1px solid #c00',zIndex:99999,whiteSpace:'pre-wrap',fontFamily:'monospace',display:'none',maxHeight:'70vh',overflow:'auto'});
        var b=document.createElement('button');b.textContent='Close';b.style.float='right';b.onclick=function(){o.style.display='none'};o.appendChild(b);
        var p=document.createElement('div');p.id='errorOverlayMsg';o.appendChild(p);
        document.body.appendChild(o);
      }
      document.getElementById('errorOverlayMsg').textContent = msg;
      document.getElementById('errorOverlay').style.display = 'block';
    }catch(e){console.error('overlay error',e)}
  }
  window.addEventListener('error', function(ev){
    var m = ev.message + '\n' + (ev.filename||'') + ':' + (ev.lineno||'') + '\n' + (ev.error && ev.error.stack ? ev.error.stack : '');
    console.error('Captured error', m);
    show(m);
  });
  window.addEventListener('unhandledrejection', function(ev){
    var m = 'UnhandledRejection: ' + (ev.reason && ev.reason.stack ? ev.reason.stack : String(ev.reason));
    console.error(m);
    show(m);
  });
  console.log('Diagnostics enabled');
})();
</script>
<div id="app">

<!-- HOME VIEW -->
<section id="view-home" class="view active">
  <h1>Rengastarkastus</h1>

  <div class="card">
    <label>Rekisterinumero</label>
    <div class="autocomplete-wrapper">
      <input id="plate">
      <div class="autocomplete-suggestions" id="plateSuggestions" style="display:none;"></div>
    </div>

    <label>Yritys</label>
    <div class="autocomplete-wrapper">
      <input id="company">
      <div class="autocomplete-suggestions" id="companySuggestions" style="display:none;"></div>
    </div>

    <label>Merkki</label>
    <div class="autocomplete-wrapper">
      <input id="make">
      <div class="autocomplete-suggestions" id="makeSuggestions" style="display:none;"></div>
    </div>

    <label>Malli</label>
    <div class="autocomplete-wrapper">
      <input id="model">
      <div class="autocomplete-suggestions" id="modelSuggestions" style="display:none;"></div>
    </div>

    <label>Ajoneuvotyyppi</label>
    <div id="vehicleType" class="vehicle-type">
      <label><input type="radio" name="vehicleType" value="Kuorma-auto"><span>Kuorma-auto</span></label>
      <label><input type="radio" name="vehicleType" value="Per√§vaunu"><span>Per√§vaunu</span></label>
      <label><input type="radio" name="vehicleType" value="Auto"><span>Auto</span></label>
    </div>

    <button class="btn primary" id="btnStartInspection">Uusi tarkastus</button>
    <button class="btn" id="btnOpenConfig">Akseli konfiguraatio</button>
  </div>

  <div class="card">
    <h2>Raportit</h2>
    <div id="historyList"></div>
  </div>
</section>

<!-- CONFIG VIEW -->
<section id="view-config" class="view">
  <header>
    <button class="btn back" data-back>‚Üê</button>
    <h2>Konfiguraatio</h2>
  </header>

  <div class="card">
    <label>Akselien m√§√§r√§</label>
    <div id="axleSelector" class="chip-group"></div>
  </div>

  <div class="card">
    <div id="configAxles"></div>
  </div>

  <div class="card">
    <button class="btn primary" id="btnSaveConfig">Tallenna</button>
  </div>
</section>

<!-- MEASUREMENT VIEW -->
<section id="view-measure" class="view">
  <header>
    <button class="btn back" data-back>‚Üê</button>
    <h2>Mittaukset</h2>
  </header>

  <div class="card">
    <div id="measureList"></div>
  </div>

  <div class="card">
    <button class="btn primary" id="btnSaveInspection">Tallenna tarkastus</button>
  </div>
</section>

<!-- PRESET MODAL -->
<div id="presetModal" class="preset-modal" style="display:none;">
  <div class="preset-modal-backdrop"></div>
  <div class="preset-modal-card">
    <h2>Valitse ajoneuvotyyppi</h2>
    <div id="presetTypes" class="preset-types"></div>
  </div>
</div>

<!-- AXLE CONFIG MODAL -->
<div id="axleConfigModal" class="preset-modal" style="display:none;">
  <div class="preset-modal-backdrop"></div>
  <div class="preset-modal-card">
    <h2>Valitse akselikonfiguraatio</h2>
    <div id="axleConfigs" class="preset-types"></div>
  </div>
</div>

</div>

<!-- Load all modules -->
<script src="./jspdf.umd.min.js"></script>
<script src="./storage.js"></script>
<script src="./constants.js"></script>
<script src="./formatters.js"></script>
<script src="./autocomplete.js"></script>
<script src="./ui-builder.js"></script>
<script src="./pdf-renderer.js"></script>

<!-- Main application logic -->
<script>
(function(){
const StorageKeys = window.StorageKeys;
const loadList = window.loadList;
const loadMap = window.loadMap;
const saveList = window.saveList;
const saveMap = window.saveMap;
const ConfigManager = window.ConfigManager;
const HistoryManager = window.HistoryManager;

const formatTyreSize = window.formatTyreSize;
const capitalizeWords = window.capitalizeWords;
const setupAutocomplete = window.setupAutocomplete;
const setupTyreAutocomplete = window.setupTyreAutocomplete;
const buildAxleUI = window.buildAxleUI;
const buildPositions = window.buildPositions;
const buildMeasurementUI = window.buildMeasurementUI;
const renderHistory = window.renderHistory;

// Elements
const plateInput = document.getElementById("plate");
const companyInput = document.getElementById("company");
const typeInput = document.getElementById("vehicleType");
const axleSelector = document.getElementById("axleSelector");
const configAxles = document.getElementById("configAxles");
const measureList = document.getElementById("measureList");
const historyList = document.getElementById("historyList");

const plateSuggestions = document.getElementById("plateSuggestions");
const companySuggestions = document.getElementById("companySuggestions");

let currentConfig = null;
let currentPositions = null;

// Autocomplete setup
setupAutocomplete(
  plateInput,
  plateSuggestions,
  ()=>loadList(StorageKeys.plates()),
  (plate)=>{
    const map = loadMap(StorageKeys.plateCompanyMap());
    if (map[plate]) companyInput.value = map[plate];
  },
  (val)=>val.toUpperCase()
);

setupAutocomplete(
  companyInput,
  companySuggestions,
  ()=>loadList(StorageKeys.companies()),
  ()=>{}
);

const makeInput = document.getElementById('make');
const makeSuggestions = document.getElementById('makeSuggestions');
const modelInput = document.getElementById('model');
const modelSuggestions = document.getElementById('modelSuggestions');

setupAutocomplete(
  makeInput,
  makeSuggestions,
  ()=>loadList(StorageKeys.makes()),
    (item)=>{ makeInput.value = capitalizeWords(item); }
);

setupAutocomplete(
  modelInput,
  modelSuggestions,
  ()=>loadList(StorageKeys.models()),
    (item)=>{ modelInput.value = capitalizeWords(item); }
);

makeInput.addEventListener('blur', ()=>{ makeInput.value = capitalizeWords(makeInput.value); });
modelInput.addEventListener('blur', ()=>{ modelInput.value = capitalizeWords(modelInput.value); });

// Build axle chips
[2,3,4,5].forEach(n=>{
  const chip = document.createElement('div');
  chip.className = 'chip';
  chip.dataset.axles = n;
  chip.textContent = n + ' akselia';
  if (n===2) chip.classList.add('active');
  axleSelector.appendChild(chip);
});

// Open config
document.getElementById("btnOpenConfig").onclick = ()=>{
  const plate = plateInput.value.trim().toUpperCase();
  if (!plate) return alert("Sy√∂t√§ rekisterinumero");
  plateInput.value = plate;

  const map = loadMap(StorageKeys.plateCompanyMap());
  if (map[plate]) companyInput.value = map[plate];

  const makemodelmap = loadMap(StorageKeys.plateMakeModelMap());
  if (makemodelmap[plate]) {
    makeInput.value = capitalizeWords(makemodelmap[plate].make || '');
    modelInput.value = capitalizeWords(makemodelmap[plate].model || '');
  }

  const vehicleTypeEl = document.querySelector('#vehicleType input[type="radio"]:checked');
  const vehicleType = vehicleTypeEl ? vehicleTypeEl.value : 'Auto';
  openAxleConfigModal(vehicleType);
};

// Show view
function showView(id) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// Back buttons
document.querySelectorAll('[data-back]').forEach(btn=> btn.addEventListener('click', ()=> showView('view-home')));

// Axle selector
axleSelector.onclick = e=>{
  const chip = e.target.closest('.chip'); if (!chip) return;
  axleSelector.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active');
  const count = Number(chip.dataset.axles);
  currentConfig = currentConfig || { axles:count, data:[] };
  currentConfig.axles = count;
  buildAxleUI(configAxles, count, currentConfig.data, StorageKeys, formatTyreSize);
};

// Save config
document.getElementById('btnSaveConfig').onclick = ()=>{
  const plate = plateInput.value.trim().toUpperCase();
  if (!plate) return alert('Sy√∂t√§ rekisterinumero');
  plateInput.value = plate;

  const cards = configAxles.querySelectorAll('.axle-card');
  const data = [...cards].map((c,idx)=>({
    type:c.querySelector('.axle-type').value,
    size:formatTyreSize(c.querySelector('.axle-size').value),
    make:c.querySelector('.axle-make').value,
    rim:c.querySelector("input[name='rim-"+idx+"']:checked").value,
    et:c.querySelector('.axle-et').value
  }));

  currentConfig.data = data;
  ConfigManager.save(plate, currentConfig);

  alert('Konfiguraatio tallennettu');
  showView('view-home');
};

// Preset/Axle config modal functions
const presetModal = document.getElementById('presetModal');
const presetTypes = document.getElementById('presetTypes');
const axleConfigModal = document.getElementById('axleConfigModal');
const axleConfigs = document.getElementById('axleConfigs');
let selectedPresetType = null;
let selectedVehicleForConfig = null;

function initPresetModal() {
  presetTypes.innerHTML = '';
  Object.keys(VEHICLE_PRESETS).forEach(type => {
    const cfgList = VEHICLE_PRESETS[type];
    const firstCfg = cfgList[0];
    const card = document.createElement('div');
    card.className = 'preset-type-card';
    const icon = type === 'Kuorma-auto' ? 'üöõ' : (type === 'Per√§vaunu' ? 'üì¶' : 'üöó');
    const axleCount = firstCfg.data.filter(a=>a.type==='single').length + ' yks. + ' + firstCfg.data.filter(a=>a.type==='dual').length + ' pari';
    card.innerHTML = `
      <div class="preset-type-icon">${icon}</div>
      <div class="preset-type-name">${type}</div>
      <div class="preset-type-info">${firstCfg.axles} akselia<br>${axleCount}</div>
    `;
    card.onclick = ()=>{
      selectedPresetType = type;
      presetTypes.querySelectorAll('.preset-type-card').forEach(c=>c.classList.remove('selected'));
      card.classList.add('selected');
      setTimeout(()=>startInspectionWithPreset(type), 200);
    };
    presetTypes.appendChild(card);
  });
}

function initAxleConfigModal(vehicleType) {
  axleConfigs.innerHTML = '';
  const cfgList = VEHICLE_PRESETS[vehicleType];
  if (!cfgList) return;
  cfgList.forEach((cfg, idx) => {
    const card = document.createElement('div');
    card.className = 'preset-type-card';
    card.innerHTML = `
      <div class="preset-type-name" style="font-size:1.1rem;">${cfg.name}</div>
    `;
    card.onclick = ()=>{
      currentConfig = { axles: cfg.axles, data: JSON.parse(JSON.stringify(cfg.data)) };
      closeAxleConfigModal();
      const plate = plateInput.value.trim().toUpperCase();
      ConfigManager.save(plate, currentConfig);
      alert('Konfiguraatio tallennettu');
      showView('view-home');
    };
    axleConfigs.appendChild(card);
  });
}

function openAxleConfigModal(vehicleType) {
  selectedVehicleForConfig = vehicleType;
  initAxleConfigModal(vehicleType);
  axleConfigModal.classList.add('open');
  axleConfigModal.style.display = 'flex';
}

function closeAxleConfigModal() {
  axleConfigModal.classList.remove('open');
  axleConfigModal.style.display = 'none';
  selectedVehicleForConfig = null;
}

function openPresetModal() {
  initPresetModal();
  presetModal.classList.add('open');
  presetModal.style.display = 'flex';
}

function closePresetModal() {
  presetModal.classList.remove('open');
  presetModal.style.display = 'none';
  selectedPresetType = null;
}

function startInspectionWithPreset(vehicleType) {
  const plate = plateInput.value.trim().toUpperCase();
  if (!plate) { closePresetModal(); return alert('Sy√∂t√§ rekisterinumero'); }
  
  closePresetModal();
  plateInput.value = plate;

  const map = loadMap(StorageKeys.plateCompanyMap());
  if (map[plate]) companyInput.value = map[plate];

  const presetList = VEHICLE_PRESETS[vehicleType];
  if (!presetList || presetList.length === 0) return alert('Konfiguraatiota ei l√∂ydy');
  const presetCfg = presetList[0];
  
  currentConfig = { axles: presetCfg.axles, data: JSON.parse(JSON.stringify(presetCfg.data)) };
  currentPositions = buildPositions(currentConfig);

  const last = HistoryManager.lastForPlate(plate);
  const prevValues = last?last.values:null;
  const prevNotes = last?last.notes:null;
  const prevPhotos = last?last.photos:null;
  const prevSizes = last?last.tireSizes:null;
  const prevMakes = last?last.tireMakes:null;
  const prevRims = last?last.tireRims:null;
  const prevEts = last?last.tireEts:null;

  const typeInputs = document.querySelectorAll('#vehicleType input[type="radio"]');
  const plateTypeMap = loadMap(StorageKeys.plateTypeMap());
  const lastWithType = [...HistoryManager.load()].reverse().find(r => r.plate === plate && r.type) || null;
  
  if (plateTypeMap[plate]) {
    typeInputs.forEach(b=>{ b.checked = (b.value === plateTypeMap[plate]); });
  } else if (lastWithType && lastWithType.type) {
    typeInputs.forEach(b=>{ b.checked = (b.value === lastWithType.type); });
  } else {
    typeInputs.forEach(b=>{ b.checked = (b.value === vehicleType); });
  }
  
  const checkedNow = document.querySelector('#vehicleType input[type="radio"]:checked');
  if (checkedNow) window.__selectedVehicleType = checkedNow.value;

  buildMeasurementUI(currentPositions, currentConfig, measureList, prevValues, prevNotes, prevPhotos, prevSizes, prevRims, prevMakes, prevEts);
  showView('view-measure');
}

// Start inspection
document.getElementById('btnStartInspection').onclick = ()=>{
  const plate = plateInput.value.trim().toUpperCase();
  if (!plate) return alert('Sy√∂t√§ rekisterinumero');
  plateInput.value = plate;

  const map = loadMap(StorageKeys.plateCompanyMap());
  if (map[plate]) companyInput.value = map[plate];

  const makemodelmap = loadMap(StorageKeys.plateMakeModelMap());
  if (makemodelmap[plate]) {
    makeInput.value = capitalizeWords(makemodelmap[plate].make || '');
    modelInput.value = capitalizeWords(makemodelmap[plate].model || '');
  }

  const cfg = ConfigManager.load(plate);
  if (!cfg) return alert('Tee akseli konfiguraatio ensin');

  currentConfig = cfg;
  currentPositions = buildPositions(cfg);

  const last = HistoryManager.lastForPlate(plate);
  const prevValues = last?last.values:null;
  const prevNotes = last?last.notes:null;
  const prevPhotos = last?last.photos:null;
  const prevSizes = last?last.tireSizes:null;
  const prevMakes = last?last.tireMakes:null;
  const prevRims = last?last.tireRims:null;
  const prevEts = last?last.tireEts:null;

  const typeInputs = document.querySelectorAll('#vehicleType input[type="radio"]');
  const plateTypeMap = loadMap(StorageKeys.plateTypeMap());
  const lastWithType = [...HistoryManager.load()].reverse().find(r => r.plate === plate && r.type) || null;
  
  if (plateTypeMap[plate]) {
    typeInputs.forEach(b=>{ b.checked = (b.value === plateTypeMap[plate]); });
  } else if (lastWithType && lastWithType.type) {
    typeInputs.forEach(b=>{ b.checked = (b.value === lastWithType.type); });
  } else {
    typeInputs.forEach(b=>{ b.checked = false; });
  }
  
  const checkedNow = document.querySelector('#vehicleType input[type="radio"]:checked');
  if (checkedNow) window.__selectedVehicleType = checkedNow.value;

  buildMeasurementUI(currentPositions, currentConfig, measureList, prevValues, prevNotes, prevPhotos, prevSizes, prevRims, prevMakes, prevEts);
  showView('view-measure');
};

// Close modals
presetModal.querySelector('.preset-modal-backdrop').onclick = closePresetModal;
axleConfigModal.querySelector('.preset-modal-backdrop').onclick = closeAxleConfigModal;

// Save inspection
document.getElementById('btnSaveInspection').onclick = ()=>{
  const plate = plateInput.value.trim().toUpperCase();
  const company = companyInput.value.trim();
  const make = capitalizeWords(makeInput.value);
  const model = capitalizeWords(modelInput.value);
    makeInput.value = make;
    modelInput.value = model;
  const selTypeEl = document.querySelector('#vehicleType input[type="radio"]:checked');
  let type = selTypeEl ? selTypeEl.value : (window.__selectedVehicleType || '');

  if (!plate) return alert('Rekisterinumero puuttuu');
  if (!currentConfig) return alert('Konfiguraatio puuttuu');

  plateInput.value = plate;

  const nodes = [...measureList.querySelectorAll('.tire-node')]
    .sort((a,b)=>Number(a.dataset.index)-Number(b.dataset.index));
  const values = nodes.map(n=>parseFloat(n.dataset.value || 0));
  const notes = nodes.map(n=> (n.dataset.note || '').trim() || null);
  const photos = nodes.map(n=> n.dataset.photo || null);
  const tireSizes = nodes.map(n=> (n.dataset.size || '').trim() || null);
  const tireMakes = nodes.map(n=> {
    const cap = capitalizeWords(n.dataset.make || '');
    n.dataset.make = cap;
    return cap || null;
  });
  const tireRims = nodes.map(n=> (n.dataset.rim || '').trim() || null);
  const tireEts = nodes.map(n=> (n.dataset.et || '').trim() || null);

  const last = HistoryManager.lastForPlate(plate);
  const wear = values.map((v,i)=>{
    if (!last || !last.values || last.values[i]==null) return null;
    return (last.values[i]-v).toFixed(1);
  });

  const record = {
    plate,
    company,
    make,
    model,
    type,
    date:new Date().toLocaleString(),
    values,
    wear,
    config:currentConfig,
    positions:currentPositions,
    notes,
    photos,
    tireSizes,
    tireMakes,
    tireRims,
    tireEts
  };

  HistoryManager.add(record);

  const plates = loadList(StorageKeys.plates());
  if (!plates.includes(plate)) { plates.push(plate); saveList(StorageKeys.plates(), plates); }

  if (company) {
    const companies = loadList(StorageKeys.companies());
    if (!companies.includes(company)) { companies.push(company); saveList(StorageKeys.companies(), companies); }
  }

  if (make) {
    const makes = loadList(StorageKeys.makes());
    if (!makes.includes(make)) { makes.push(make); saveList(StorageKeys.makes(), makes); }
  }

  if (model) {
    const models = loadList(StorageKeys.models());
    if (!models.includes(model)) { models.push(model); saveList(StorageKeys.models(), models); }
  }

  const map = loadMap(StorageKeys.plateCompanyMap());
  if (company) { map[plate] = company; saveMap(StorageKeys.plateCompanyMap(), map); }

  const makemodelmap = loadMap(StorageKeys.plateMakeModelMap());
  if (make || model) { makemodelmap[plate] = { make, model }; saveMap(StorageKeys.plateMakeModelMap(), makemodelmap); }

  const plateTypeMap = loadMap(StorageKeys.plateTypeMap());
  if (type) { plateTypeMap[plate] = type; saveMap(StorageKeys.plateTypeMap(), plateTypeMap); }

  currentConfig.data.forEach(a=>{
    if (a.size) {
      const list = loadList(StorageKeys.tyreSizes()); if (!list.includes(a.size)) { list.push(a.size); saveList(StorageKeys.tyreSizes(), list); }
    }
    if (a.make) {
      const list = loadList(StorageKeys.tyreMakes()); if (!list.includes(a.make)) { list.push(a.make); saveList(StorageKeys.tyreMakes(), list); }
    }
    if (a.et) {
      const list = loadList(StorageKeys.etValues()); if (!list.includes(a.et)) { list.push(a.et); saveList(StorageKeys.etValues(), list); }
    }
  });

  const enteredTyreMakes = [...new Set(tireMakes.filter(Boolean))];
  if (enteredTyreMakes.length) {
    const list = loadList(StorageKeys.tyreMakes());
    let changed = false;
    enteredTyreMakes.forEach(m=>{
      if (!list.includes(m)) {
        list.push(m);
        changed = true;
      }
    });
    if (changed) saveList(StorageKeys.tyreMakes(), list);
  }

  const enteredTyreEts = [...new Set(tireEts.filter(Boolean))];
  if (enteredTyreEts.length) {
    const list = loadList(StorageKeys.etValues());
    let changed = false;
    enteredTyreEts.forEach(et=>{
      if (!list.includes(et)) {
        list.push(et);
        changed = true;
      }
    });
    if (changed) saveList(StorageKeys.etValues(), list);
  }

  alert('Tarkastus tallennettu');
  showView('view-home');
  renderHistory(historyList, HistoryManager);
};

// Initial render
renderHistory(historyList, HistoryManager);

// Vehicle type radio change handler
(function(){
  const radios = document.querySelectorAll('#vehicleType input[type="radio"]');
  radios.forEach(r => r.addEventListener('change', (e)=>{
    window.__selectedVehicleType = e.target.value;
  }));
})();

// Expose helper
window.__app = { renderHistory };
})();
</script>
</body>
</html>
