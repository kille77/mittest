<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rengastarkastus 3.0</title>

<link rel="stylesheet" href="./styles.css">
</head>

<body>
<script>
// Diagnostic overlay to capture runtime errors and promise rejections
;(function(){
  function show(msg){
    try{
      var o=document.getElementById('errorOverlay');
      if(!o){
        o=document.createElement('div');o.id='errorOverlay';
        Object.assign(o.style,{position:'fixed',left:'8px',right:'8px',top:'8px',padding:'12px',background:'#fee',color:'#600',border:'1px solid #c00',zIndex:99999,whiteSpace:'pre-wrap',fontFamily:'monospace',display:'none',maxHeight:'70vh',overflow:'auto'});
        var b=document.createElement('button');b.textContent='Close';b.style.float='right';b.onclick=function(){o.style.display='none'};o.appendChild(b);
        var p=document.createElement('div');p.id='errorOverlayMsg';o.appendChild(p);
        document.body.appendChild(o);
      }
      document.getElementById('errorOverlayMsg').textContent = msg;
      document.getElementById('errorOverlay').style.display = 'block';
    }catch(e){console.error('overlay error',e)}
  }
  window.addEventListener('error', function(ev){
    var m = ev.message + '\n' + (ev.filename||'') + ':' + (ev.lineno||'') + '\n' + (ev.error && ev.error.stack ? ev.error.stack : '');
    console.error('Captured error', m);
    show(m);
  });
  window.addEventListener('unhandledrejection', function(ev){
    var m = 'UnhandledRejection: ' + (ev.reason && ev.reason.stack ? ev.reason.stack : String(ev.reason));
    console.error(m);
    show(m);
  });
  console.log('Diagnostics enabled');
})();
</script>
<div id="app">

<!-- HOME VIEW -->
<section id="view-home" class="view active">
  <h1>Rengastarkastus</h1>

  <div class="card">
    <label>Rekisterinumero</label>
    <div class="autocomplete-wrapper">
      <input id="plate">
      <div class="autocomplete-suggestions" id="plateSuggestions" style="display:none;"></div>
    </div>

    <label>Yritys</label>
    <div class="autocomplete-wrapper">
      <input id="company">
      <div class="autocomplete-suggestions" id="companySuggestions" style="display:none;"></div>
    </div>

    <label>Ajoneuvotyyppi</label>
    <div id="vehicleType" class="vehicle-type">
      <label><input type="radio" name="vehicleType" value="Kuorma-auto"><span>Kuorma-auto</span></label>
      <label><input type="radio" name="vehicleType" value="Perävaunu"><span>Perävaunu</span></label>
      <label><input type="radio" name="vehicleType" value="Auto"><span>Auto</span></label>
    </div>

    <button class="btn primary" id="btnStartInspection">Uusi tarkastus</button>
    <button class="btn" id="btnOpenConfig">Rengaskonfiguraatio</button>
  </div>

  <div class="card">
    <h2>Raportit</h2>
    <div id="historyList"></div>
  </div>
</section>

<!-- CONFIG VIEW -->
<section id="view-config" class="view">
  <header>
    <button class="btn back" data-back>←</button>
    <h2>Konfiguraatio</h2>
  </header>

  <div class="card">
    <label>Akselien määrä</label>
    <div id="axleSelector" class="chip-group"></div>
  </div>

  <div id="configAxles"></div>

  <button class="btn primary" id="btnSaveConfig">Tallenna konfiguraatio</button>
</section>

<!-- MEASURE VIEW -->
<section id="view-measure" class="view">
  <header>
    <button class="btn back" data-back>←</button>
    <h2>Mittaukset</h2>
  </header>

  <div id="measureList"></div>

  <button class="btn primary" id="btnSaveInspection">Tallenna tarkastus</button>
</section>

</div>

<script src="./jspdf.umd.min.js"></script>
<script>
class _StorageKeys {
  static config(plate) { return "config_" + plate; }
  static history() { return "history"; }
  static plates() { return "plates"; }
  static companies() { return "companies"; }
  static tyreSizes() { return "tyreSizes"; }
  static tyreMakes() { return "tyreMakes"; }
  static etValues() { return "etValues"; }
  static plateCompanyMap() { return "plateCompanyMap"; }
  static plateTypeMap() { return "plateTypeMap"; }
}

function loadList(key) {
  const raw = localStorage.getItem(key);
  return raw ? JSON.parse(raw) : [];
}
function saveList(key, list) {
  localStorage.setItem(key, JSON.stringify(list));
}
function loadMap(key) {
  const raw = localStorage.getItem(key);
  return raw ? JSON.parse(raw) : {};
}
function saveMap(key, map) {
  localStorage.setItem(key, JSON.stringify(map));
}

class ConfigManager {
  static load(plate) {
    const raw = localStorage.getItem(_StorageKeys.config(plate));
    return raw ? JSON.parse(raw) : null;
  }
  static save(plate, config) {
    localStorage.setItem(_StorageKeys.config(plate), JSON.stringify(config));
  }
}

class HistoryManager {
  static load() {
    const raw = localStorage.getItem(_StorageKeys.history());
    return raw ? JSON.parse(raw) : [];
  }
  static save(list) {
    localStorage.setItem(_StorageKeys.history(), JSON.stringify(list));
  }
  static add(record) {
    const list = this.load();
    list.push(record);
    this.save(list);
  }
  static lastForPlate(plate) {
    return [...this.load()].reverse().find(r => r.plate === plate) || null;
  }
}

window.StorageKeys = _StorageKeys;
window.loadList = loadList;
window.saveList = saveList;
window.loadMap = loadMap;
window.saveMap = saveMap;
window.ConfigManager = ConfigManager;
window.HistoryManager = HistoryManager;
</script>

<script>
function formatTyreSize(raw) {
  if (!raw) return "";
  if (raw.includes("/")) return raw.trim();
  const d = raw.replace(/\D/g,"");
  // 38555225 -> 385/55R22.5
  if (d.length === 8) return `${d.slice(0,3)}/${d.slice(3,5)}R${d.slice(5,7)}.${d.slice(7)}`;
  // 3855522 -> 385/55R22
  if (d.length === 7) return `${d.slice(0,3)}/${d.slice(3,5)}R${d.slice(5,7)}`;
  return raw.trim();
}
function setupAutocomplete(inputEl, suggestionsEl, getItems, onSelect, transformInput=null) {
  function closeSuggestions() {
    suggestionsEl.style.display = "none";
    suggestionsEl.innerHTML = "";
  }

  function openSuggestions(items) {
    if (!items.length) { closeSuggestions(); return; }
    suggestionsEl.innerHTML = "";
    items.forEach(item=>{
      const div = document.createElement("div");
      div.className = "autocomplete-suggestion";
      div.textContent = item;
      div.onclick = (e)=>{ e.stopPropagation(); inputEl.value = item; closeSuggestions(); onSelect(item); };
      suggestionsEl.appendChild(div);
    });
    suggestionsEl.style.display = "block";
  }

  inputEl.addEventListener("input", ()=>{
    let val = inputEl.value;
    if (transformInput) {
      val = transformInput(val);
      inputEl.value = val;
    }
    const all = getItems();
    if (!val) { closeSuggestions(); return; }
    const filtered = all.filter(x => x.toLowerCase().includes(val.toLowerCase()));
    openSuggestions(filtered);
  });

  inputEl.addEventListener("focus", ()=>{
    const val = inputEl.value;
    const all = getItems();
    if (!val) {
      if (all.length) openSuggestions(all.slice(0,10));
    } else {
      const filtered = all.filter(x => x.toLowerCase().includes(val.toLowerCase()));
      openSuggestions(filtered);
    }
  });

  document.addEventListener("click", e=>{
    if (!inputEl.contains(e.target) && !suggestionsEl.contains(e.target)) {
      closeSuggestions();
    }
  });
}

function setupTyreAutocomplete(inputEl, key, formatter=null) {
  const wrap = document.createElement("div");
  wrap.className = "autocomplete-wrapper";
  inputEl.parentNode.insertBefore(wrap, inputEl);
  wrap.appendChild(inputEl);

  const sug = document.createElement("div");
  sug.className = "autocomplete-suggestions";
  sug.style.display = "none";
  wrap.appendChild(sug);

  setupAutocomplete(
    inputEl,
    sug,
    ()=>loadList(key),
    ()=>{},
    formatter
  );
}

function buildAxleUI(containerEl, count, existing=[], StorageKeysRef, formatTyreSizeFn) {
  containerEl.innerHTML = "";

  for (let i=0;i<count;i++) {
    const d = existing[i] || {};

    const card = document.createElement("div");
    card.className = "axle-card";

    card.innerHTML = `
      <h3>Akseli ${i+1}</h3>
      <div class="settings-icon">⚙️</div>
      <div class="settings-menu">
        <div data-copy="size">Kopioi rengaskoko kaikille</div>
        <div data-copy="make">Kopioi merkki kaikille</div>
        <div data-copy="rim">Kopioi vanne kaikille</div>
        <div data-copy="et">Kopioi ET kaikille</div>
      </div>

      <label>Tyyppi</label>
      <select class="axle-type">
        <option value="single"${d.type==="single"?" selected":""}>Yksittäinen</option>
        <option value="dual"${d.type==="dual"?" selected":""}>Paripyörä</option>
      </select>

      <label>Rengaskoko</label>
        <input type="text" class="axle-size" value="${d.size||""}" placeholder="315/70R22.5" inputmode="numeric" pattern="[0-9]*">

      <label>Merkki ja malli</label>
      <input class="axle-make" value="${d.make||""}">

      <label>Vannetyyppi</label>
      <div class="rim-options">
        <label class="rim-option">
          <input type="radio" name="rim-${i}" value="Alumiini" ${!d.rim || d.rim==="Alumiini" ? "checked":""}>
          Alumiini
        </label>
        <label class="rim-option">
          <input type="radio" name="rim-${i}" value="Teräs" ${d.rim==="Teräs" ? "checked":""}>
          Teräs
        </label>
      </div>

      <label>ET-arvo</label>
      <input class="axle-et" value="${d.et||""}">
    `;

    containerEl.appendChild(card);

    setupTyreAutocomplete(card.querySelector(".axle-size"), StorageKeysRef.tyreSizes(), formatTyreSizeFn);
    setupTyreAutocomplete(card.querySelector(".axle-make"), StorageKeysRef.tyreMakes());
    setupTyreAutocomplete(card.querySelector(".axle-et"), StorageKeysRef.etValues());

    card.querySelector(".axle-size").addEventListener("blur", e=>{ e.target.value = formatTyreSizeFn(e.target.value); });

    const icon = card.querySelector(".settings-icon");
    const menu = card.querySelector(".settings-menu");

    icon.onclick = (e)=>{ e.stopPropagation(); document.querySelectorAll(".settings-menu").forEach(m=>m.style.display="none"); menu.style.display = "block"; };
    document.addEventListener("click", ()=>{ menu.style.display = "none"; });

    menu.querySelectorAll("[data-copy]").forEach(btn=>{
      btn.onclick = (e)=>{
        e.stopPropagation();
        const type = btn.dataset.copy;
        const cards = containerEl.querySelectorAll(".axle-card");

        if (type === "size") {
          const val = card.querySelector(".axle-size").value.trim();
          if (!val) return alert("Rengaskoko puuttuu");
          const f = formatTyreSizeFn(val);
          cards.forEach(c=>c.querySelector(".axle-size").value = f);
        }

        if (type === "make") {
          const val = card.querySelector(".axle-make").value.trim();
          cards.forEach(c=>c.querySelector(".axle-make").value = val);
        }

        if (type === "rim") {
          const val = card.querySelector("input[name='rim-"+i+"']:checked").value;
          cards.forEach((c,idx)=>{ c.querySelector("input[name='rim-"+idx+"'][value='"+val+"']").checked = true; });
        }

        if (type === "et") {
          const val = card.querySelector(".axle-et").value.trim();
          cards.forEach(c=>c.querySelector(".axle-et").value = val);
        }
      };
    });
  }
}

function buildPositions(config) {
  const left = [];
  const right = [];

  config.data.forEach((axle, index) => {
    const n = index + 1;

    if (axle.type === "single") {
      left.push(`Vasen ${n} `);
      right.push(`Oikea ${n} `);
    } else {
      left.push(`Vasen ulompi ${n} `);
      left.push(`Vasen sisempi ${n} `);
      right.push(`Oikea ulompi ${n} `);
      right.push(`Oikea sisempi ${n} `);
    }
  });

  return [...left, ...right];
}

function buildMeasurementUI(
  positions,
  containerEl,
  previous = null,
  prevNotes = null,
  prevPhotos = null
) {
  containerEl.innerHTML = "";

  positions.forEach((p, i) => {
    const row = document.createElement("div");
    row.className = "tyre-row";

    const value = previous ? previous[i] : 10;
    const noteText = prevNotes && prevNotes[i] ? prevNotes[i] : "";
    const hasPhoto = prevPhotos && prevPhotos[i];

    row.innerHTML = `
      <div class="tyre-main">
        <div>${p}</div>
        <div class="tyre-controls" style="display:flex;align-items:center;gap:10px;">
          <input
            type="range"
            min="0"
            max="20"
            step="0.5"
            value="${value}"
            class="tyre-slider"
            style="width:100px;"
          >
          <span class="slider-value">${parseFloat(value).toFixed(1)}</span> mm
          <button class="btn-sm note-toggle" title="Huomio">&#9888;</button>
          <button class="btn-sm photo-btn" title="Ota kuva">&#128247;</button>
          <input
            type="file"
            accept="image/*"
            capture="environment"
            class="photo-input"
            style="display:none;"
          >
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:flex-start;margin-top:6px;">
        <div class="note-box" style="display:none;flex:1;">
          <textarea class="note-input" placeholder="Kirjoita huomio...">${noteText}</textarea>
        </div>

        <div class="photo-preview" style="
          width:80px;
          height:60px;
          border:1px solid #eee;
          border-radius:6px;
          overflow:hidden;
          display:${hasPhoto ? "block" : "none"};
        ">
          ${hasPhoto ? `<img src="${prevPhotos[i]}" style="width:100%;height:100%;object-fit:cover">` : ""}
        </div>
      </div>
    `;

    containerEl.appendChild(row);

    /* ---------- Slider ---------- */
    const slider = row.querySelector(".tyre-slider");
    const valueSpan = row.querySelector(".slider-value");

    slider.addEventListener("input", () => {
      valueSpan.textContent = parseFloat(slider.value).toFixed(1);
    });

    /* ---------- Notes ---------- */
    const noteBox = row.querySelector(".note-box");
    const noteBtn = row.querySelector(".note-toggle");

    noteBtn.onclick = () => {
      noteBox.style.display =
        noteBox.style.display === "none" ? "block" : "none";
    };

    // Optional: mark button if a note exists
    if (noteText.trim()) {
      noteBtn.classList.add("has-note");
    }

    /* ---------- Photos ---------- */
    const photoBtn = row.querySelector(".photo-btn");
    const photoInput = row.querySelector(".photo-input");
    const preview = row.querySelector(".photo-preview");

    if (hasPhoto) {
      row.dataset.photo = prevPhotos[i];
    }

    photoBtn.onclick = () => photoInput.click();

    photoInput.onchange = (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        row.dataset.photo = reader.result;
        preview.innerHTML = `<img src="${reader.result}" style="width:100%;height:100%;object-fit:cover">`;
        preview.style.display = "block";
      };
      reader.readAsDataURL(file);
    };
  });
}


function renderHistory(containerEl, HistoryManagerRef) {
  const list = HistoryManagerRef.load();
  containerEl.innerHTML = "";
  if (!list.length) {
    containerEl.innerHTML = "<p>Ei tallennettuja raportteja.</p>";
    return;
  }

  // Group by company -> plate -> records
  const map = {};
  list.forEach((r, idx)=>{
    const company = r.company || "Ilman yritystä";
    if (!map[company]) map[company] = {};
    if (!map[company][r.plate]) map[company][r.plate] = [];
    map[company][r.plate].push({rec:r, idx});
  });

  Object.keys(map).forEach(company=>{
    const compCard = document.createElement('div');
    compCard.className = 'card';
    compCard.innerHTML = `<h3>${company} <button class="btn-sm" data-download-company="${company}" style="margin-left:8px;">Lataa kaikki</button></h3>`;

    Object.keys(map[company]).forEach(plate=>{
      const arr = map[company][plate];
      const plateDiv = document.createElement('div');
      plateDiv.style.marginBottom = '8px';
      
      const headerDiv = document.createElement('div');
      headerDiv.style.display = 'flex';
      headerDiv.style.alignItems = 'center';
      headerDiv.style.justifyContent = 'space-between';
      headerDiv.style.cursor = 'pointer';
      headerDiv.style.padding = '8px';
      headerDiv.style.backgroundColor = '#f9f9f9';
      headerDiv.style.borderRadius = '6px';
      headerDiv.style.marginBottom = '8px';
      
      const leftPart = document.createElement('div');
      leftPart.style.display = 'flex';
      leftPart.style.alignItems = 'center';
      leftPart.style.gap = '8px';
      leftPart.style.flex = '1';
      
      const toggle = document.createElement('span');
      toggle.textContent = '▼';
      toggle.style.transition = 'transform 0.2s';
      toggle.style.display = 'inline-block';
      toggle.style.fontSize = '0.8rem';
      toggle.dataset.expanded = 'true';
      
      const titleSpan = document.createElement('span');
      titleSpan.innerHTML = `<strong>${plate}</strong> <small>(${arr.length} raporttia)</small>`;
      
      leftPart.appendChild(toggle);
      leftPart.appendChild(titleSpan);
      
      const downloadBtn = document.createElement('button');
      downloadBtn.className = 'btn-sm';
      downloadBtn.setAttribute('data-download-plate', plate);
      downloadBtn.textContent = 'Lataa kaikki (ajoneuvo)';
      downloadBtn.style.marginLeft = '8px';
      downloadBtn.onclick = (e)=>e.stopPropagation();
      
      headerDiv.appendChild(leftPart);
      headerDiv.appendChild(downloadBtn);
      
      const reportsContainer = document.createElement('div');
      reportsContainer.className = 'plate-reports-container';
      reportsContainer.style.display = 'block';
      reportsContainer.style.overflow = 'hidden';
      reportsContainer.style.transition = 'max-height 0.3s ease';
      reportsContainer.style.maxHeight = '1000px';
      
      arr.forEach(entry=>{
        const r = entry.rec;
        const i = entry.idx;
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `
          <div>
            <small>${r.date}</small>
          </div>
          <div class="history-actions">
            <button class="btn-sm primary" data-pdf="${i}">PDF</button>
            <button class="btn-sm danger" data-del="${i}">X</button>
          </div>
        `;
        reportsContainer.appendChild(item);
      });
      
      headerDiv.onclick = ()=>{
        const isExpanded = toggle.dataset.expanded === 'true';
        if (isExpanded) {
          reportsContainer.style.maxHeight = '0px';
          toggle.style.transform = 'rotate(-90deg)';
          toggle.dataset.expanded = 'false';
        } else {
          reportsContainer.style.maxHeight = '1000px';
          toggle.style.transform = 'rotate(0deg)';
          toggle.dataset.expanded = 'true';
        }
      };
      
      plateDiv.appendChild(headerDiv);
      plateDiv.appendChild(reportsContainer);
      compCard.appendChild(plateDiv);
    });

    containerEl.appendChild(compCard);
  });

  containerEl.querySelectorAll('[data-del]').forEach(btn=>{
    btn.onclick = ()=>{
      const list = HistoryManagerRef.load();
      list.splice(btn.dataset.del,1);
      HistoryManagerRef.save(list);
      renderHistory(containerEl, HistoryManagerRef);
    };
  });

  containerEl.querySelectorAll('[data-pdf]').forEach(btn=>{
    btn.onclick = ()=> {
      if (window.generatePdf) window.generatePdf(btn.dataset.pdf);
      else alert('PDF ei saatavilla (jsPDF ei ladattu)');
    };
  });

  containerEl.querySelectorAll('[data-download-company]').forEach(btn=>{
    btn.onclick = ()=>{
      const company = btn.dataset.downloadCompany;
      if (window.generateCompanyPdf) window.generateCompanyPdf(company);
      else alert('PDF-työkalu ei saatavilla');
    };
  });

  containerEl.querySelectorAll('[data-download-plate]').forEach(btn=>{
    btn.onclick = ()=>{
      const plate = btn.dataset.downloadPlate;
      if (window.generateVehiclePdf) window.generateVehiclePdf(plate);
      else alert('PDF-työkalu ei saatavilla');
    };
  });
}

// expose to global for non-module usage
window.formatTyreSize = formatTyreSize;
window.setupAutocomplete = setupAutocomplete;
window.setupTyreAutocomplete = setupTyreAutocomplete;
window.buildAxleUI = buildAxleUI;
window.buildPositions = buildPositions;
window.buildMeasurementUI = buildMeasurementUI;
window.renderHistory = renderHistory;
</script>

<script>
function generatePdf(index) {
  if (!window.HistoryManager) return alert('Historia ei saatavilla');
  if (!window.jspdf) return alert('jsPDF ei ladattu - lataa sivu palvelimelta tai lisää jspdf paikallisesti');
  const { jsPDF } = window.jspdf;
  const list = window.HistoryManager.load();
  const r = list[index];
  if (!r) return;

  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text("Rengastarkastusraportti",20,20);

  doc.setFontSize(11);
  doc.text(`Rekisterinumero: ${r.plate}`,20,30);
  doc.text(`Yritys: ${r.company||"-"}`,20,36);
  doc.text(`Tyyppi: ${r.type||"-"}`,20,42);
  doc.text(`Päiväys: ${r.date}`,20,48);

  let y=60;
  doc.setFontSize(12);
  doc.text("Akselikonfiguraatio",20,y);
  y+=6;

  doc.setFontSize(10);
  doc.text("Akseli",20,y);
  doc.text("Koko",50,y);
  doc.text("Merkki",90,y);
  doc.text("Vanne",140,y);
  doc.text("ET",170,y);
  y+=4;
  doc.line(20,y,190,y);
  y+=4;

  r.config.data.forEach((a,i)=>{
    doc.text(String(i+1),20,y);
    doc.text(a.size||"-",50,y);
    doc.text(a.make||"-",90,y);
    doc.text(a.rim||"-",140,y);
    doc.text(a.et||"-",170,y);
    y+=6;
  });

  y+=10;
  doc.setFontSize(12);
  doc.text("Rengasmittaukset",20,y);
  y+=6;

  doc.setFontSize(10);
  doc.text("Sijainti",20,y);
  doc.text("Mitta",90,y);
  doc.text("Kuluminen",130,y);
  doc.text("Huomio",160,y);
  y+=4;
  doc.line(20,y,190,y);
  y+=6;

  r.positions.forEach((p,i)=>{
    const v = r.values[i];
    const w = r.wear[i];
    let note = r.notes && r.notes[i] ? r.notes[i] : "";
    if (!note) {
      if (v<2) note="Vaihda";
      else if (v<4) note="Seurattava";
    }

    doc.text(p,20,y);
    doc.text(String(v),90,y);
    doc.text(w!=null?String(w):"-",130,y);

    // If photo exists, draw small thumbnail at right
    const photo = r.photos && r.photos[i] ? r.photos[i] : null;
    if (photo) {
      try {
        doc.addImage(photo, 'JPEG', 160, y-6, 30, 30);
      } catch(e) {
        // ignore image errors
      }
    } else {
      doc.text(note||"-",160,y);
    }

    y+=36;
    if (y>250) {
      doc.addPage();
      y=20;
    }
  });

  doc.save((r.plate||"raportti")+"_raportti.pdf");
}

window.generatePdf = generatePdf;

function generateCompanyPdf(company) {
  if (!window.HistoryManager) return alert('Historia ei saatavilla');
  const raw = window.HistoryManager.load().filter(r => (r.company||"Ilman yritystä") === company);
  // Keep newest-first but only the newest record per vehicle (plate)
  const reversed = raw.slice().reverse();
  const seen = new Set();
  const list = [];
  for (const r of reversed) {
    if (!seen.has(r.plate)) { seen.add(r.plate); list.push(r); }
  }
  if (!list.length) return alert('Ei raportteja valitulle yritykselle');

  // If real jsPDF is available, produce a single PDF with one vehicle per page
  if (window.jspdf && window.jspdf.jsPDF && typeof window.jspdf.jsPDF === 'function') {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Render one report per PDF page (newest-first). Use compact layout so
    // each report fits a single page and avoid adding intermediate blank pages.
    list.forEach((r, idx) => {
      if (idx > 0) doc.addPage();

      doc.setFontSize(14);
      doc.text("Rengastarkastusraportti",20,20);

      doc.setFontSize(10);
      doc.text(`Rekisterinumero: ${r.plate}`,20,28);
      doc.text(`Yritys: ${r.company||"-"}`,110,28);
      doc.text(`Tyyppi: ${r.type||"-"}`,20,34);
      doc.text(`Päiväys: ${r.date}`,110,34);

      let y = 44;
      doc.setFontSize(9);
      // A compact axle table
      doc.text("Akseli",20,y); doc.text("Koko",40,y); doc.text("Merkki",80,y); doc.text("Vanne",130,y); doc.text("ET",170,y);
      y += 4;
      (r.config && r.config.data || []).forEach((a,i)=>{
        doc.text(String(i+1),20,y);
        doc.text(a.size||"-",40,y);
        doc.text(a.make||"-",80,y);
        doc.text(a.rim||"-",130,y);
        doc.text(a.et||"-",170,y);
        y += 6;
      });

      y += 6;
      doc.setFontSize(9);
      doc.text("Sijainti",20,y); doc.text("Mitta",100,y); doc.text("Kuluminen",140,y); doc.text("Huomio",170,y);
      y += 4;

      // Compact measurements rows; stop writing extra lines if page would overflow
      (r.positions || []).forEach((p,i)=>{
        if (y > 270) return; // keep within printable area
        const v = r.values && r.values[i];
        const w = r.wear && r.wear[i];
        let note = r.notes && r.notes[i] ? r.notes[i] : "";
        if (!note) { if (v<2) note = "Vaihda"; else if (v<4) note = "Seurattava"; }

        const photo = r.photos && r.photos[i] ? r.photos[i] : null;

        doc.text(p,20,y);
        doc.text(String(v),100,y);
        doc.text(w!=null?String(w):"-",140,y);

        if (photo) {
          try {
            const m = (photo.match(/^data:image\/(\w+);base64,/)||[])[1] || 'jpeg';
            const fmt = (m.toUpperCase()==='JPG'?'JPEG':m.toUpperCase());
            doc.addImage(photo, fmt, 150, y-4, 40, 30);
          } catch(e) {}
          y += 36;
        } else {
          doc.text(note||"-",170,y);
          y += 6;
        }
      });
    });

    doc.save((company||'yritys')+"_raportit.pdf");
    return;
  }

  // Fallback: open printable HTML with page-breaks and trigger print (user can Save as PDF)
  let html = '<!doctype html><html><head><meta charset="utf-8"><title>Raportit '+(company||'')+'</title>'+
    '<style>body{font-family:Arial,Helvetica,sans-serif;font-size:12px;padding:12px} .page{page-break-after:always;margin-bottom:12px} table{border-collapse:collapse;width:100%} th,td{border:1px solid #ccc;padding:6px;text-align:left}</style></head><body>';

  list.forEach(r=>{
    html += `<div class="page"><h2>Rek ${r.plate} — ${r.date}</h2><p>Yritys: ${r.company||'-'}<br/>Tyyppi: ${r.type||'-'}</p>`;
    html += '<h3>Akselikonfiguraatio</h3><table><tr><th>Akseli</th><th>Koko</th><th>Merkki</th><th>Vanne</th><th>ET</th></tr>';
    (r.config && r.config.data || []).forEach((a,i)=>{ html += `<tr><td>${i+1}</td><td>${a.size||'-'}</td><td>${a.make||'-'}</td><td>${a.rim||'-'}</td><td>${a.et||'-'}</td></tr>`; });
    html += '</table>';
    html += '<h3>Mittaukset</h3><table><tr><th>Sijainti</th><th>Mitta</th><th>Kuluminen</th><th>Huomio</th><th>Kuva</th></tr>';
    (r.positions || []).forEach((p,i)=>{
      const v = r.values && r.values[i];
      const w = r.wear && r.wear[i];
      let note = r.notes && r.notes[i] ? r.notes[i] : "";
      if (!note) { if (v<2) note = 'Vaihda'; else if (v<4) note = 'Seurattava'; }
      const photo = r.photos && r.photos[i] ? r.photos[i] : null;
      html += `<tr><td>${p}</td><td>${v}</td><td>${w!=null?w:'-'}</td><td>${note||'-'}</td><td>${photo?`<img src="${photo}" style="max-width:160px;max-height:90px">`:'-'}</td></tr>`;
    });
    html += '</table></div>';
  });

  html += '</body></html>';
  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}

window.generateCompanyPdf = generateCompanyPdf;

function generateVehiclePdf(plate) {
  if (!window.HistoryManager) return alert('Historia ei saatavilla');
  const raw = window.HistoryManager.load().filter(r => r.plate === plate);
  if (!raw.length) return alert('Ei raportteja valitulle ajoneuvolle');

  // newest-first
  const list = raw.slice().reverse();

  if (window.jspdf && window.jspdf.jsPDF && typeof window.jspdf.jsPDF === 'function') {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    list.forEach((r, idx) => {
      if (idx > 0) doc.addPage();

      doc.setFontSize(14);
      doc.text("Rengastarkastusraportti",20,20);
      doc.setFontSize(10);
      doc.text(`Rekisterinumero: ${r.plate}`,20,28);
      doc.text(`Yritys: ${r.company||"-"}`,110,28);
      doc.text(`Tyyppi: ${r.type||"-"}`,20,34);
      doc.text(`Päiväys: ${r.date}`,110,34);

      let y = 44;
      doc.setFontSize(9);
      doc.text("Akseli",20,y); doc.text("Koko",40,y); doc.text("Merkki",80,y); doc.text("Vanne",130,y); doc.text("ET",170,y);
      y += 4;
      (r.config && r.config.data || []).forEach((a,i)=>{
        doc.text(String(i+1),20,y);
        doc.text(a.size||"-",40,y);
        doc.text(a.make||"-",80,y);
        doc.text(a.rim||"-",130,y);
        doc.text(a.et||"-",170,y);
        y += 6;
      });

      y += 6;
      doc.setFontSize(9);
      doc.text("Sijainti",20,y); doc.text("Mitta",100,y); doc.text("Kuluminen",140,y); doc.text("Huomio",170,y);
      y += 4;

      (r.positions || []).forEach((p,i)=>{
        if (y > 270) return;
        const v = r.values && r.values[i];
        const w = r.wear && r.wear[i];
        let note = r.notes && r.notes[i] ? r.notes[i] : "";
        if (!note) { if (v<2) note = "Vaihda"; else if (v<4) note = "Seurattava"; }

        const photo = r.photos && r.photos[i] ? r.photos[i] : null;

        doc.text(p,20,y);
        doc.text(String(v),100,y);
        doc.text(w!=null?String(w):"-",140,y);

        if (photo) {
          try {
            const m = (photo.match(/^data:image\/(\w+);base64,/)||[])[1] || 'jpeg';
            const fmt = (m.toUpperCase()==='JPG'?'JPEG':m.toUpperCase());
            doc.addImage(photo, fmt, 150, y-4, 40, 30);
          } catch(e) {}
          y += 36;
        } else {
          doc.text(note||"-",170,y);
          y += 6;
        }
      });
    });

    doc.save((plate||'ajoneuvo')+"_raportit.pdf");
    return;
  }

  // Fallback printable HTML
  let html = '<!doctype html><html><head><meta charset="utf-8"><title>Raportit '+(plate||'')+'</title>'+
    '<style>body{font-family:Arial,Helvetica,sans-serif;font-size:12px;padding:12px} .page{page-break-after:always;margin-bottom:12px} table{border-collapse:collapse;width:100%} th,td{border:1px solid #ccc;padding:6px;text-align:left}</style></head><body>';

  list.forEach(r=>{
    html += `<div class="page"><h2>Rek ${r.plate} — ${r.date}</h2><p>Yritys: ${r.company||'-'}<br/>Tyyppi: ${r.type||'-'}</p>`;
    html += '<h3>Akselikonfiguraatio</h3><table><tr><th>Akseli</th><th>Koko</th><th>Merkki</th><th>Vanne</th><th>ET</th></tr>';
    (r.config && r.config.data || []).forEach((a,i)=>{ html += `<tr><td>${i+1}</td><td>${a.size||'-'}</td><td>${a.make||'-'}</td><td>${a.rim||'-'}</td><td>${a.et||'-'}</td></tr>`; });
    html += '</table>';
    html += '<h3>Mittaukset</h3><table><tr><th>Sijainti</th><th>Mitta</th><th>Kuluminen</th><th>Huomio</th></tr>';
    (r.positions || []).forEach((p,i)=>{
      const v = r.values && r.values[i];
      const w = r.wear && r.wear[i];
      let note = r.notes && r.notes[i] ? r.notes[i] : "";
      if (!note) { if (v<2) note = 'Vaihda'; else if (v<4) note = 'Seurattava'; }
      html += `<tr><td>${p}</td><td>${v}</td><td>${w!=null?w:'-'}</td><td>${note||'-'}</td></tr>`;
    });
    html += '</table></div>';
  });

  html += '</body></html>';
  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}

window.generateVehiclePdf = generateVehiclePdf;
</script>

<script>(function(){
// Using globals attached to window instead of ES module imports to allow file:// usage
const StorageKeys = window.StorageKeys;
const loadList = window.loadList;
const loadMap = window.loadMap;
const saveList = window.saveList;
const saveMap = window.saveMap;
const ConfigManager = window.ConfigManager;
const HistoryManager = window.HistoryManager;

const formatTyreSize = window.formatTyreSize;
const setupAutocomplete = window.setupAutocomplete;
const setupTyreAutocomplete = window.setupTyreAutocomplete;
const buildAxleUI = window.buildAxleUI;
const buildPositions = window.buildPositions;
const buildMeasurementUI = window.buildMeasurementUI;
const renderHistory = window.renderHistory;

// Elements
const plateInput = document.getElementById("plate");
const companyInput = document.getElementById("company");
const typeInput = document.getElementById("vehicleType");
const axleSelector = document.getElementById("axleSelector");
const configAxles = document.getElementById("configAxles");
const measureList = document.getElementById("measureList");
const historyList = document.getElementById("historyList");

const plateSuggestions = document.getElementById("plateSuggestions");
const companySuggestions = document.getElementById("companySuggestions");

let currentConfig = null;
let currentPositions = null;

// Autocomplete setup
setupAutocomplete(
  plateInput,
  plateSuggestions,
  ()=>loadList(StorageKeys.plates()),
  (plate)=>{
    const map = loadMap(StorageKeys.plateCompanyMap());
    if (map[plate]) companyInput.value = map[plate];
  },
  (val)=>val.toUpperCase()
);

setupAutocomplete(
  companyInput,
  companySuggestions,
  ()=>loadList(StorageKeys.companies()),
  ()=>{}
);

// Build axle chips
[2,3,4,5].forEach(n=>{
  const chip = document.createElement('div');
  chip.className = 'chip';
  chip.dataset.axles = n;
  chip.textContent = n + ' akselia';
  if (n===2) chip.classList.add('active');
  axleSelector.appendChild(chip);
});

// Open config
document.getElementById("btnOpenConfig").onclick = ()=>{
  const plate = plateInput.value.trim().toUpperCase();
  if (!plate) return alert("Syötä rekisterinumero");
  plateInput.value = plate;

  const map = loadMap(StorageKeys.plateCompanyMap());
  if (map[plate]) companyInput.value = map[plate];

  const cfg = ConfigManager.load(plate) || { axles:2, data:[] };
  currentConfig = cfg;

  axleSelector.querySelectorAll(".chip").forEach(c=>{ c.classList.toggle("active", Number(c.dataset.axles)===cfg.axles); });

  buildAxleUI(configAxles, cfg.axles, cfg.data, StorageKeys, formatTyreSize);
  showView('view-config');
};

// Show view helper
function showView(id) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// Back buttons
document.querySelectorAll('[data-back]').forEach(btn=> btn.addEventListener('click', ()=> showView('view-home')));

// Axle selector click
axleSelector.onclick = e=>{
  const chip = e.target.closest('.chip'); if (!chip) return;
  axleSelector.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active');
  const count = Number(chip.dataset.axles);
  currentConfig = currentConfig || { axles:count, data:[] };
  currentConfig.axles = count;
  buildAxleUI(configAxles, count, currentConfig.data, StorageKeys, formatTyreSize);
};

// Save config
document.getElementById('btnSaveConfig').onclick = ()=>{
  const plate = plateInput.value.trim().toUpperCase();
  if (!plate) return alert('Syötä rekisterinumero');
  plateInput.value = plate;

  const cards = configAxles.querySelectorAll('.axle-card');
  const data = [...cards].map((c,idx)=>({
    type:c.querySelector('.axle-type').value,
    size:formatTyreSize(c.querySelector('.axle-size').value),
    make:c.querySelector('.axle-make').value,
    rim:c.querySelector("input[name='rim-"+idx+"']:checked").value,
    et:c.querySelector('.axle-et').value
  }));

  currentConfig.data = data;
  ConfigManager.save(plate, currentConfig);

  alert('Konfiguraatio tallennettu');
  showView('view-home');
};

// Start inspection
document.getElementById('btnStartInspection').onclick = ()=>{
  const plate = plateInput.value.trim().toUpperCase();
  if (!plate) return alert('Syötä rekisterinumero');
  plateInput.value = plate;

  const map = loadMap(StorageKeys.plateCompanyMap());
  if (map[plate]) companyInput.value = map[plate];

  const cfg = ConfigManager.load(plate);
  if (!cfg) return alert('Tee konfiguraatio ensin');

  currentConfig = cfg;
  currentPositions = buildPositions(cfg);

  const last = HistoryManager.lastForPlate(plate);
  const prevValues = last?last.values:null;
  const prevNotes = last?last.notes:null;
  const prevPhotos = last?last.photos:null;

  // Prefill vehicle type radio: prefer stored plate type, else fall back to last record
  const plateTypeMap = loadMap(StorageKeys.plateTypeMap());
  const typeInputs = document.querySelectorAll('#vehicleType input[type="radio"]');
  // Find the most recent history entry for this plate that actually has a non-empty type
  const lastWithType = [...HistoryManager.load()].reverse().find(r => r.plate === plate && r.type) || null;
  console.log('StartInspection debug:', { plate, stored: plateTypeMap[plate], lastType: last && last.type, lastWithType: lastWithType && lastWithType.type, inputs: typeInputs.length });
  if (plateTypeMap[plate]) {
    typeInputs.forEach(b=>{ b.checked = (b.value === plateTypeMap[plate]); });
  } else if (lastWithType && lastWithType.type) {
    typeInputs.forEach(b=>{ b.checked = (b.value === lastWithType.type); });
  } else if (last && last.type) {
    typeInputs.forEach(b=>{ b.checked = (b.value === last.type); });
  } else {
    typeInputs.forEach(b=>{ b.checked = false; });
  }
  // record current selection in a global so saves/read can access it reliably
  const checkedNow = document.querySelector('#vehicleType input[type="radio"]:checked');
  if (checkedNow) window.__selectedVehicleType = checkedNow.value;

  buildMeasurementUI(currentPositions, measureList, prevValues, prevNotes, prevPhotos);
  showView('view-measure');
};

// Save inspection
document.getElementById('btnSaveInspection').onclick = ()=>{
  const plate = plateInput.value.trim().toUpperCase();
  const company = companyInput.value.trim();
  const selTypeEl = document.querySelector('#vehicleType input[type="radio"]:checked');
  let type = selTypeEl ? selTypeEl.value : (window.__selectedVehicleType || '');
  console.log('SaveInspection debug BEFORE save:', { plate, type, inputs: document.querySelectorAll('#vehicleType input[type="radio"]').length, storedBefore: loadMap(StorageKeys.plateTypeMap())[plate] });

  if (!plate) return alert('Rekisterinumero puuttuu');
  if (!currentConfig) return alert('Konfiguraatio puuttuu');

  plateInput.value = plate;

  const sliders = measureList.querySelectorAll("input.tyre-slider");
  const values = [...sliders].map(i=>parseFloat(i.value||0));

  const noteInputs = measureList.querySelectorAll('.note-input');
  const notes = [...noteInputs].map(t=>t.value.trim() || null);

  const rows = measureList.querySelectorAll('.tyre-row');
  const photos = [...rows].map(r=> r.dataset.photo || null);

  const last = HistoryManager.lastForPlate(plate);
  const wear = values.map((v,i)=>{
    if (!last || !last.values || last.values[i]==null) return null;
    return (last.values[i]-v).toFixed(1);
  });

  const record = {
    plate,
    company,
    type,
    date:new Date().toLocaleString(),
    values,
    wear,
    config:currentConfig,
    positions:currentPositions,
    notes,
    photos
  };

  HistoryManager.add(record);

  const plates = loadList(StorageKeys.plates());
  if (!plates.includes(plate)) { plates.push(plate); saveList(StorageKeys.plates(), plates); }

  if (company) {
    const companies = loadList(StorageKeys.companies());
    if (!companies.includes(company)) { companies.push(company); saveList(StorageKeys.companies(), companies); }
  }

  const map = loadMap(StorageKeys.plateCompanyMap());
  if (company) { map[plate] = company; saveMap(StorageKeys.plateCompanyMap(), map); }

  // Remember vehicle type per plate
  const plateTypeMap = loadMap(StorageKeys.plateTypeMap());
  if (type) { plateTypeMap[plate] = type; saveMap(StorageKeys.plateTypeMap(), plateTypeMap); console.log('SaveInspection debug AFTER save:', { saved: plateTypeMap[plate] }); }

  currentConfig.data.forEach(a=>{
    if (a.size) {
      const list = loadList(StorageKeys.tyreSizes()); if (!list.includes(a.size)) { list.push(a.size); saveList(StorageKeys.tyreSizes(), list); }
    }
    if (a.make) {
      const list = loadList(StorageKeys.tyreMakes()); if (!list.includes(a.make)) { list.push(a.make); saveList(StorageKeys.tyreMakes(), list); }
    }
    if (a.et) {
      const list = loadList(StorageKeys.etValues()); if (!list.includes(a.et)) { list.push(a.et); saveList(StorageKeys.etValues(), list); }
    }
  });

  alert('Tarkastus tallennettu');
  showView('view-home');
  renderHistory(historyList, HistoryManager);
};

// Initial render
renderHistory(historyList, HistoryManager);

// Vehicle type radio change handler: keep a global selected value
(function(){
  const radios = document.querySelectorAll('#vehicleType input[type="radio"]');
  radios.forEach(r => r.addEventListener('change', (e)=>{
    window.__selectedVehicleType = e.target.value;
    try{ const m = loadMap(StorageKeys.plateTypeMap()); /* no-op, just ensure function is available */ }catch(e){}
    console.log('vehicleType change ->', window.__selectedVehicleType);
  }));
})();

// Expose helper for other scripts
window.__app = { renderHistory };
})();</script>
</body>
</html>

